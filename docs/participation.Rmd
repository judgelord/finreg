---
title: "Participation in Financial Rulemaking"
#subtitle: "Appendix and Replication Code"
output:
    bookdown::html_document2:
      highlight: zenburn
      toc: true
      toc_float: true
      code_folding: hide
      number_sections: false
---

```{r options, include=FALSE}
library(marginaleffects)
library(fixest)

# rmarkdown::render("docs/participation.Rmd")
source(here::here("code", "setup.R"))

## Change defaults for R chunks
knitr::opts_chunk$set(cache = FALSE,
                      fig.path = "../figs/",
                      #fig.retina = 3, #6, #FIXME for publication-quality images 
                      fig.height = 3,
                      fig.width = 7)
```


# Data

```{r}
read_csv(here::here("data", "master_tables_status.csv")) %>% 
  mutate(attachments_table = replace_na(attachments_table, 0)) %>% 
  rename(`attachments table` = attachments_table,
         `efficacy and sophistication measures` =`term counts`) %>% 
  kablebox()
```

The root for this script is `finreg`. Most of the data are in `finreg/data` (some in a subfolder `merged_resources`). Others are up one level in `FINREGRULEMAKE2/Data`. This can and should be streamlined significantly. 

Rules and comments: 

- Agency actions: `finreg/data/actions.csv`
- RIN-level data: `finreg/data/dodd-frank-rulemaking-directory_doc_oriented_wdescription.xls` and `finreg/data/docket_related_rin_lookup.csv`
- Docket-level comment data: `finreg/data/matches_per_docket.csv`


Resource data: 
- For commenters: `finreg/data/match_data_clean.Rdata`

Resource data for the full population of organizations, including non-commenters: 

- Non-profit `assets` and `revenue` from 990 data from https://www.irs.gov/charities-non-profits/form-990-series-downloads: `finreg/data/nonprofit_resources.Rdata` or `finreg/data/merged_resources/nonprofits_resources.csv`
- FDIC assets (`ASSET`) and bank class (`BKCLASS`): `finreg/data/FDIC_resources.Rdata` or `finreg/data/merged_resources/FDIC_Institutions.csv`
- Credit unions `Total Assets` scraped from consolidated call report files scraped from https://www.ncua.gov/analysis/credit-union-corporate-call-report-data by `acquisition/get_credit-Unions.py`: `Data/creditunions.csv` (up one level, not in finreg)
- Campaign donations (`MeanContribAmount` and `MeanContribAmountPerYearContributed`) from https://www.opensecrets.org/: `finreg/data/merged_resources/opensecrets_resources_JwVersion.csv`
- Market capitalization (`marketcap`) from compustat? `Data/compustat_names.csv` and SEC's CIK database `Data/CIK.csv`: `finreg/data/merged_resources/compustat_resources.csv`

A helpful description of types of banks can be found here: https://www.ffiec.gov/npw/Help/InstitutionTypes

Sophistication and Efficacy Measures are described here: https://judgelord.github.io/finreg/efficacy

```{r action-data}
# actions 
actions <- read_csv(here("data" , "actions.csv"))

actions %>% distinct(docket_id) %>% nrow

library(readxl)

rins <- read_excel(here::here("data", "dodd-frank-rulemaking-directory_doc_oriented_wdescription.xls")) %>% 
  rename(docket_id = identifier)  %>% 
  dplyr::select(-"...1")

lookup <- read_csv(here::here("data", "docket_related_rin_lookup.csv")) %>% 
  dplyr::select(-"...1") %>% 
  mutate(across(everything(), str_squish))

rin_lookup <- full_join(rins, lookup, by = "docket_id", suffix = c(".directory", ".lookup")) %>% 
  mutate(title = str_to_title(title) %>% str_squish()) %>% 
  mutate(across(everything(), str_squish))
```

```{r actions, fig.width=7, fig.height=6, out.width="100%", fig.cap= "Dodd-Frank Act Implimenting Actions by Agency", cache=FALSE}
wide =  read.csv( here::here("data", "pivot_example.csv") )
n_rules <- nrow(wide)

long = read.csv( here::here("data", "actions.csv") )

long %<>% 
  mutate(year = publication_date %>% str_sub(1,4),
         Stage = stage  %>% 
           str_replace("ANPR", "Advance NPRM (ANPRM)") %>% 
           str_replace("^FINAL", "Final Rule") %>% 
           str_replace("GUIDANCE", "Guidance") %>% 
           str_replace("INTERIM-FINAL", "Interim Final Rule") %>% 
           str_replace("^NPR", "Notice of Proposed\nRulemaking (NPRM)")) %>% 
    group_by(agency_acronym) %>%
  add_count(name = "agency_total") %>% 
  ungroup()

n_actions <- nrow(long)

long %>% 
  filter(Stage %in% c("Advance NPRM (ANPRM)", "Final Rule", "Interim Final Rule", "Notice of Proposed\nRulemaking (NPRM)"),
         agency_acronym %in% c("FRS", "CFPB", "SEC", "CFTC", "FDIC", "OCC",  "NCUA") ) %>% 
  count(year, agency_acronym, Stage) %>% 
  ggplot() +
  aes(y = n, x = year, fill = Stage) %>% 
  geom_col(alpha = .8) + 
  facet_wrap("agency_acronym", scales = "free") +
  scale_fill_viridis_d() +
  labs(fill = "Document Type",
       x = "", 
       y = "",
       caption = "Dodd-Frank regulatory actions from  the Consumer Financial Protection Bureau (CFPB),
Commodity Futures Trading Commission (CFTC), Federal Deposit Insurance Corporation (FIDC), 
Federal Reserve (FRS), National Credit Union Administration (NCUA), 
Office of the Comptroller of the Currency (OCC), and Securities and Exchange Commission (SEC)") + 
  theme_minimal() +
  theme(axis.text.x = element_text(hjust = .7, angle = 60),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.caption = element_text(hjust = 0))
```

Some dockets don't have related rins in the lookup table 
```{r rins-missing}
# ~35/2 with different comment counts per docket 
# ~325/2 with different titles per docket 
# ~98/2 with different related RINS / lowest related rin per docket 
# 115/2 with different docket_urls

# missing related RINs
rin_lookup %>% 
  dplyr::select(# title, 
    docket_id,
    RIN.directory, RIN.lookup,
         related.rins, 
         lowest.sorted.rin.of.related.rins, 
         docket_url.directory, docket_url.lookup,
             comment_count) %>%
  distinct() %>% 
  filter(is.na(related.rins)) %>% 
  kablebox()
```

## Dockets with more than one RIN

```{r rin-lookup}
rin_lookup %>% 
  dplyr::select(# title, 
    docket_id,
    RIN.directory, RIN.lookup,
         related.rins, 
         lowest.sorted.rin.of.related.rins, 
         docket_url.directory, docket_url.lookup,
             comment_count) %>%
  distinct() %>% 
  filter(!is.na(related.rins)) %>% 
  add_count( docket_id) %>%
  arrange(docket_id) %>% 
  filter(n > 1) %>%   
  distinct() %>% 
  kablebox()

rin_lookup %<>% 
  dplyr::select(-RIN.directory,
         -docket_url.directory) %>% distinct()

names(rin_lookup) %<>% str_remove(".lookup")
```

---

## Asset data

Summary table data here: 

```{r docket-table, fig.height=5.5, fig.width=5.4, out.width="80%"}
# clean match data from finreg_commenter_covariates
docket_table <- read_csv(here::here("data", "matches_per_docket.csv"))

docket_table %>% 
  add_count(Agency) %>% 
  mutate(Agency = paste(n, "dockets from", Agency)) %>% 
  dplyr::select(Agency, Comments, `Any Resources Measure`) %>% 
  group_by(Agency) %>% 
  summarise_all(sum) %>% 
  group_by(Agency) %>% 
  pivot_longer(cols = c("Comments", contains(" ") ))  %>% 
  mutate(Matched = ifelse(name == "Comments", "Total","Matched"),
         name = ifelse(name == "Comments", "Total", name)) %>% 
  ggplot() + 
  aes(fill = name,
      y = Matched, 
      x = value) + 
    geom_col(position = "stack", alpha = .7) + 
  labs(x = "Comments", y = "", fill = "",
       title = "Comments Matched to Organizational Resources Data") + 
  facet_wrap("Agency", ncol = 1, scales = "free") + 
  theme(legend.position = "bottom",
        panel.grid.major.y = element_blank(),
        strip.text = element_text(size = 12)) 


# FIXME 
docket_table %>% 
  add_count(Agency) %>% 
  mutate(Agency = paste(n, "dockets from", Agency)) %>% 
  dplyr::select(- Percent, - Docket, -`Any Resources Measure`) %>% 
  group_by(Agency) %>% 
  summarise_all(sum) %>% 
  group_by(Agency) %>% 
  pivot_longer(cols = c("Comments", contains(" ") ))  %>% 
  mutate(Matched = ifelse(name == "Comments", "Total","Matched"),
         name = ifelse(name == "Comments", "Total", name)) %>% 
  ggplot() + 
  aes(fill = name,
      y = Matched, 
      x = value) + 
    geom_col(position = "stack", alpha = .7) + 
  labs(x = "Comments", y = "", fill = "Resource\nData Type",
       title = "Comments Matched to Organizational Resources Data") + 
  facet_wrap("Agency", ncol = 1, scales = "free") + 
  theme(legend.position = "bottom",
        panel.grid.major.y = element_blank(),
        strip.text = element_text(size = 12)) 
```

### Dockets with most comments matched

```{r}
docket_table %<>% 
  arrange(-`Any Resources Measure`) 

# max
docket_table %>% 
  # filter(`Any Resources Measure` < 1) %>% 
  knitr::kable() %>% 
  kable_paper(full_width = F) %>%
  column_spec(5, color = "white",
              background = spec_color(docket_table$Comments/ docket_table$`Any Resources Measure`, begin = .1, end = .9, direction = 1, option = 3) ) %>% 
  scroll_box(height = "400px")
```

### Dockets with the fewest commments matched
```{r}
docket_table %<>% 
  arrange(`Any Resources Measure`) 

# min
docket_table %>% 
  # filter(`Any Resources Measure` < 1) %>% 
  knitr::kable() %>% 
  kable_paper(full_width = F) %>%
  column_spec(5, color = "white",
              background = spec_color(docket_table$Comments/ docket_table$`Any Resources Measure`, begin = .1, end = .9, direction = 1, option = 5) ) %>% 
  scroll_box(height = "400px")
```


### Load asset data 
```{r}
#FDIC-density
# load(here("data", "FDIC_resources.Rdata"))

# CSVs for simplicity 
FDIC_resources <- read_csv(here::here("data", "merged_resources", "FDIC_Institutions.csv"))

#load the full population of campaign donors 
creditunions <- read_csv(here("Data" , "creditunions.csv") %>% str_remove("finreg/") )

#load the full population of campaign donors 
opensecrets <- read_csv(here("data" , "merged_resources", 
"opensecrets_resources_JwVersion.csv") )
opensecrets <- read_csv( here::here("data", "Lobbying_and_Contributions.csv")  )


# all nonprofit data from IRS 
nonprofit_resources <- read_csv(here("data", "merged_resources", "nonprofits_resources.csv"))

# load IRS data with c3-c6 variable (this is large)
load(here::here("data", "IRS990-2012-2021.RData"))
skimr::skim(IRS990_2012_2021)

IRS990_2012_2021 %<>% distinct(EIN, NAME, SUBSECTION, AFFILIATION)

IRS990_2012_2021 %>% count(SUBSECTION)

IRS990_2012_2021 %>% count(EIN, sort = T)

IRS990_2012_2021 %<>% distinct(EIN, ORGANIZATION, SUBSECTION)

nonprofit_resources %>% 
  filter(
    #str_dct(name, "^chamber of commerce$")
    ein == 530045720
    ) %>%
  arrange(-assets) %>%  kablebox()

# CIK org names + market cap from compustat (in casees where the compustat version of the name matched better )
cik <- read_csv(here("data/merged_resources/CIK.csv"))

compustat <- read_csv(here("data/merged_resources/compustat_resources.csv"))

compustat %>% add_count(cik, marketcap) %>% arrange(-n) %>% kablebox()

# CIK org names + market cap from compustat (in casees where the compustat version of the name matched better )
sec <- read_csv(here("data/merged_resources/SEC_Institutions.csv")) %>% 
  rename(cik = CIK)
```

### Load comments matched to org names
```{r data-match-clean}
# clean match data from finreg_commenter_covariates
load(here("data", "match_data_clean.Rdata"))


match_data_clean %>% count(comment_agency)

d <- match_data_clean  

d %>% count(comment_url, sort = T)

d %>% add_count(comment_url) %>% arrange(-n) %>% select(comment_url, organization, n, best_match_name) %>%  filter(n>1) %>% write_csv(here::here("data", "inspect", "duplicate_comment_urls.csv"))

# unique ids to merge on 
d %<>% 
  mutate(
    CERT = ifelse(org_type2 %in% c("Other Company",  "Bank"), 
                  `FDIC_Institutions-bestMatch:CERT`, 
                  NA),
    cik = coalesce(
    `compustat_resources-bestMatch:cik`, 
    `SEC_Institutions-bestMatch:CIK`,
    `CIK-bestMatch:CIK`
    ) %>% 
      as.character(),
    cik = ifelse(org_type2 %in% c("Other Company",  "Bank"),
                       cik,
                       NA
         ),
    rssd = coalesce(
      `CreditUnions-bestMatch:RSSD`, 
      `FDIC_Institutions-bestMatch:FED_RSSD`, 
      `FFIECInstitutions-bestMatch:IDRSSD`),
    rssd = ifelse(org_type2 %in% c("Other Company",  "Bank"),
                       rssd,
                       NA
         ),
    ein = ifelse(
                org_type2 %in% c( "Other Nonprofit","Credit Union"),
                `nonprofits_resources-bestMatch:ein`,
                NA
              ),
    parentID =    `opensecrets_resources_jwVersion-bestMatch:parentID`
  )
```




## By organization type 

```{r org_count_type, fig.width=5.5, fig.height=2.3}
d %<>% mutate(#org_comment = ifelse(is_likely_org == 1, "Likely Org", "Likely Not Org"),
              Agency = str_to_upper(comment_agency))


# comments 
d %>% group_by(Agency, org_type2) %>% 
  drop_na(org_type2) %>% # FIXME WHY ARE THERE NAs 
  count() %>% 
  ggplot() +
  aes(x = Agency, y = n, fill = org_type2) + 
  geom_col() + 
  labs(fill = "Type of Organization",
       y = "Number of Comments")




# unique orgs 
d %>% nrow() 

d %>% distinct(org_name) %>% nrow() 

d %>% distinct(Agency, org_type2, org_name) %>% 
  drop_na(org_type2) %>% 
  group_by(Agency, org_type2) %>% 
  count() %>%
  ggplot() +
  aes(x = Agency, y = n, fill = org_type2) + 
  geom_col() + 
  labs(fill = "Type of Organization",
       y = "Number of Organizations")

 # caption = "Consumer Financial Protection Bureau (CFPB)
 #       Commodity Futures Trading Commission (CFTC)
 #       Federal Reserve (FRS)
 #       National Credit Union Administration (NCUA)
 #       Securities and Exchange Commission (SEC)"


org_count_agency <- d %>% 
  count(org_name, org_type2,  Agency)

org_count <- d  %>% 
  count(org_name, org_type2)

ein_count <- d %>% 
  filter(org_type2 == "Other Nonprofit") %>% 
  count(`nonprofits_resources-bestMatch:ein`)
```

---

## Comments per docket

```{r rins-table}
d %>% count(Agency, docket_id) %>% 
  group_by(Agency) %>%
  summarise(mean_comments = mean(n),
            median_comments = median(n)) %>% 
  kablebox()



d_rin_lookup <- d %>% full_join(rin_lookup) %>% 
  distinct(docket_id,
         #  RIN,
         related.rins, 
         lowest.sorted.rin.of.related.rins, 
         #docket_url,  
         comment_count,
         comment_url) %>% 
  group_by(docket_id) %>%
  mutate(comments_matched = sum(!is.na(comment_url) ) ) %>% 
  mutate(comment_count = as.numeric(comment_count)) %>% 
  dplyr::select(docket_id, comment_count,comments_matched, everything()) %>% 
  arrange(docket_id) %>% 
  filter(!is.na(docket_id))

d_rin_lookup  %>% 
  dplyr::select(-comment_url) %>% 
  distinct() %>% 
  #filter(comments_matched > 0)
  kablebox()
```

Some of these appear to be over-matched, but it is also possible that the comment counts are wrong. 

```{r rins-table-comments-counts}
# 6 over matched 
d_rin_lookup %>% 
  filter(comment_count < comments_matched) %>%
  #arrange(comment_url) %>% 
  dplyr::select(-comment_url) %>% 
  distinct() %>% 
  kablebox()
```

---

### Payday loan rule

The payday loan rule accounts for 90% of credit union comments and 50% of nonprofit comments, and 75% of open secrets matched comments in the current data.
15% of nonprofits and 30% of opensecrets matches commented only on the payday loan rule

```{r org_count_type-payday, fig.width=7.5, fig.height=2.5}
d %<>% mutate(payday = ifelse(str_detect(comment_url, "CFPB-2016-0025|CFPB-2019-0006"), "Payday Loan Rules", "All Other Rules"))

d %>% 
  drop_na(org_type2) %>% 
  group_by(Agency, org_type2, payday) %>% 
  count() %>% 
  ggplot() +
  aes(x = Agency, y = n, fill = org_type2) + 
  geom_col() + 
  labs(fill = "Type of Organanization",
       y = "Number of Comments") + 
  facet_wrap("payday")

d %>% 
  drop_na(org_type2) %>% 
  distinct(Agency, org_name, payday, org_type2) %>% 
  group_by(Agency, org_type2, payday) %>% 
  count(Agency,org_type2, payday) %>% 
  ggplot() +
  aes(x = Agency, y = n, fill = org_type2) + 
  geom_col() + 
  labs(fill = "Type of Organanization",
       y = "Number of Organizations") + 
  facet_wrap("payday")


# number of payday loan comments per org 
d %>% 
  #filter(payday == "Payday Loan Rules") %>% 
  count(comment_org_name, best_match_name, sort = T) %>% 
  kablebox() 

```

## Potential false matches

### These are dropped for now

```{r false-matches}

false_match <- "nknown|private investor|individual investor|private individual|self employed|american citizen|us citizen|b d | store 7|debt trap|financial 3|united states congress|lending bear|check city partnership|plan nevada|clarity services|title cash|antipoverty coalition greater dallas|faith fair lending|south carolina state senate|florida alliance consumer protection|minneapolis grain exchange|asset management group securities industry financial markets association|american title escrow|ssociation financial guaranty insurers|credit union association dakotas|working group commercial energy firms|center capital markets competitiveness|chelsea title nature coast|kendall county|california nevada credit union leagues|futures industry association fia|pennsylvania housing finance agency|members congress|new york portfolio clearing|check city partnership|central title|committee on investment employee benefit assets|futures industry association|national association independent housing professionals|dryden tax managed funds|dreyfus edison electric index fund|building trades organizing project|n y$"

sus_match <- "national rural electric cooperative association|st louis community credit union|advance america|american financial services association|check cash"

# possible false positives
d %>% drop_na(best_match_name) %>% filter(str_detect(comment_org_name, false_match)) %>% nrow() %>% paste("potential false matches")

# false positive orgs 
d  %>% drop_na(best_match_name) %>% filter(str_detect(comment_org_name, false_match)) %>% 
  count(comment_org_name, best_match_name, sort = T) %>% 
  #kable(format = "markdown")
  kablebox()

# false positive comments 
d  %>% drop_na(best_match_name) %>%
  filter(str_detect(comment_org_name,  false_match)) %>% 
  dplyr::select(#starts_with("docket"), 
    starts_with("comment"),
         starts_with("best") ) %>% 
  dplyr::select( -comment_agency) %>% 
  kablebox()


false_matches <- d  %>% drop_na(best_match_name) %>% filter(str_detect(comment_org_name, false_match))

write_csv(false_matches, here("data", "inspect", "potential_false_matches.csv"))


# drop false matches 
d %<>% filter(!str_detect(comment_org_name, false_match))


d %>% 
  filter(str_detect(best_match_name, "financial")) %>% 
  arrange(-org_comments) %>% 
  dplyr::select(org_comments, comment_org_name,  best_match_name, comment_url, everything()) %>% 
  kablebox()
```

### Suspect matches

#### These are not dropped 
```{r}
sus_match <- "national rural electric cooperative association|st louis community credit union|advance america"

# possible false positives
d %>% drop_na(best_match_name) %>% filter(str_detect(comment_org_name, sus_match)) %>% nrow() %>% paste("potential false matches")

# false positive orgs 
d  %>% drop_na(best_match_name) %>% filter(str_detect(comment_org_name, sus_match)) %>% 
  count(comment_org_name, best_match_name, sort = T) %>% 
  #kable(format = "markdown")
  kablebox()
```

---



## Commenters matched to other datasets of known organizations

```{r match_data}
# 2k
 paste("Credit Union matches: ", sum(!is.na(d$CreditUnions_name)) )

d %>% filter(!is.na(CreditUnions_name)) %>% dplyr::select(ends_with("name"), comment_url) %>% kablebox()

# 5k
 paste("CIK matches: ", sum(!is.na(d$CIK_name)) )

d %>% filter(!is.na(CIK_name)) %>% dplyr::select(ends_with("name"), comment_url)  %>% kablebox()

# 1k
 paste("FDIC_Institutions matches: ", sum(!is.na(d$FDIC_Institutions_name)) )

d %>% filter(!is.na(FDIC_Institutions_name)) %>% dplyr::select(ends_with("name"), comment_url) %>% kablebox()

# 0
 paste("FFIECInstitutions matches: ", sum(!is.na(d$FFIECInstitutions_name)) )

#d %>% filter(!is.na(FFIECInstitutions_name)) %>% dplyr::select(ends_with("name")) %>% kablebox()

# 18k
 paste("NonProfitTax matches: ", sum(!is.na(d$nonprofits_resources_name)) )

d %>% filter(!is.na(nonprofits_resources_name)) %>% dplyr::select(ends_with("name"), comment_url) %>% kablebox()

# 4k
 paste("OpenSecrets matches: ", sum(!is.na(d$opensecrets_resources_name)) )

d %>% filter(!is.na(opensecrets_resources_name)) %>% dplyr::select(ends_with("name"), comment_url) %>% kablebox()

# 4k
 paste("Compustat matches: ", sum(!is.na(d$compustat_resources_name)) )


# 0
 paste("SEC matches: ", sum(!is.na(d$SEC_Institutions_name)))

# d %>% filter(!is.na(SEC_Institutions_name)) %>% dplyr::select(ends_with("name"))  %>% kablebox()
 
```

Example Comment URLs
```{r, eval=TRUE}
#Example urls

d %>% group_by(Agency) %>% 
  slice(1) %>% 
  dplyr::select(docket_id, comment_url) %>% 
  kablebox()
```

---

# Participation by organization resources





## Comparing public companies that did and did not comment on Dodd-Frank rules

### FDIC Data 

```{r FDIC-density, fig.height=2, fig.width=3, out.width="50%"}

# FDIC DATA ARE UNIQUE TO CERT but not to RSSD 
 FDIC_resources %>% count(NAME,  CERT, sort = T)

FDIC_resources %>% kablebox()


d_banks <- d %>% filter(org_type2 == "Bank")

FDIC_resources %<>%
  dplyr::select(NAME, NAMEHCR, STALP, STNAME, BKCLASS, ASSET, CERT, FED_RSSD) %>% 
  mutate(org_name = str_to_lower(NAME)) %>% 
  mutate(commented = org_name %in% d_banks$best_match_name | org_name %in% d_banks$FDIC_Institutions_name |  org_name %in%  d_banks$organization | CERT %in% d_banks$CERT | FED_RSSD %in% d_banks$rssd)

FDIC_resources %>% count(commented)

# ????
FDIC_resources %>% filter(commented & !org_name %in% d$org_name) %>% left_join(
  d %>% select(CERT = `FDIC_Institutions-bestMatch:CERT`, org_name_matched =org_name, comment_org_name, org_type2) %>% distinct()
) %>% 
  select(org_type2, comment_org_name,org_name_matched, org_name, everything()) %>% kablebox()


FDIC_resources %<>% 
  mutate(Commented = ifelse(commented, "Commented", "Did not comment")) 
  
FDIC_resources %>% 
  #filter(assets > 100) %>% 
  ggplot() + 
  aes(x = ASSET/1000000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = "Banks",
       fill = "", y = "", x = "Assets (Millions)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())
```

Counts
```{r FDIC-count, fig.height=3, fig.width=3, out.width="50%"}
# FDIC-count
# FDIC_resources$com %<>% 
#   mutate(Commented = ifelse(
#     org_name %in% d$best_match_name,
#     "Commented", 
#     "Did not comment")) 

# Dropping banks with less than $100
FDIC_resources %<>%  filter(ASSET > 1000) 

FDIC_resources %<>%  
    group_by(Commented) %>% 
  mutate(mean_ASSET = mean(ASSET, na.rm =TRUE),
         median_ASSET = median(ASSET, na.rm =TRUE)) %>% 
  group_by(Commented, BKCLASS) %>%
  mutate(mean_ASSET_type = mean(ASSET, na.rm =TRUE),
         median_ASSET_type = median(ASSET, na.rm =TRUE)) 



FDIC_resources %>% densityplot()


FDIC_resources %<>% 
  filter(#BKCLASS != "N", 
         BKCLASS != "OI") 

FDIC_resources %>%
  densityplot()

FDIC_resources %>% distinct(Commented, mean_ASSET, median_ASSET) %>% kable()

FDIC_resources %>% distinct(Commented, BKCLASS, mean_ASSET_type, median_ASSET_type) %>% arrange(BKCLASS) %>% kablebox()


FDIC_resources %>%
  filter(ASSET > 10) %>% 
  mutate(Commented = Commented %>% paste0(         
    "\n(median = $", round(median_ASSET, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET, 0) %>% prettyNum(big.mark = ","), ")")) %>% 
  ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET/1000)) + 
    geom_vline( aes(xintercept = median_ASSET/1000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = "All U.S. Banks",fill = "", y = "", x = "Assets (Thousands)") + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```

---

### FDIC instituttions

#### National Associations

I am dropping National Associations for now because we are not matching some important ones, including JP Morgan Chase, Wells Fargo, Bank of America, CitiBank, PNC BANK, Capital One, U.S. Bank, TD Bank, and Chase Bank. 

This appears to be caused by commenting organizations matching to other FDIC classes (SA, SM, NM) or other datasets (mostly CIK). If the latter, this will hopefully be fixed when we allow matches across datasets, but if it is the former, and we only allow one match per dataset (as is appropriate), then we might need to think more about the best approach to matching these, perhaps selecting by largest assets.  

```{r FDIC-count-national-association, fig.height=3, fig.width=4, out.width="50%"}
#FDIC-count-national-association 

# class N
FDIC_resources %>% filter(BKCLASS == "N") %>% distinct(org_name, ASSET, Commented) %>% arrange(-ASSET) %>% kablebox()

# jpmorgan and wells fargo banks 
FDIC_resources %>% filter(str_detect(org_name, "morgan|jp morgan|morgan chase|wells fargo|^bank of america|capital one|td bank|chase bank")) %>% distinct(BKCLASS, org_name, ASSET, CERT, Commented) %>% arrange(-ASSET) %>% kablebox()

d %>% filter(str_dct(org_name, "jp morgan chase bank")) %>% kablebox()

# FIXME ???? WHERE IS JP MORGAN CHACE IN THE FDIC DATA? 
FDIC_resources %>% filter(CERT == 3249 | CERT == 23614)

FDIC_resources %>% count(Commented) %>% mutate(percent = n/nrow(FDIC_resources))

FDIC_resources %>% group_by(BKCLASS) %>%
  mutate(nbkclass = n() ) %>% count(Commented, nbkclass) %>% mutate(percent = n/nbkclass) 

fdic_t <- t.test(FDIC_resources %>% filter(commented) %>% pull(ASSET),
       FDIC_resources %>% filter(!commented) %>% pull(ASSET))
fdic_t

fdic_tNM <- t.test(FDIC_resources %>% filter(commented, BKCLASS == "NM") %>% pull(ASSET),
       FDIC_resources %>% filter(!commented, BKCLASS == "NM") %>% pull(ASSET))
fdic_tNM

fdic_tSM <- t.test(FDIC_resources %>% filter(commented, BKCLASS == "SM") %>% pull(ASSET),
       FDIC_resources %>% filter(!commented, BKCLASS == "SM") %>% pull(ASSET))
fdic_tSM 

fdic_tSB <- t.test(FDIC_resources %>% filter(commented, BKCLASS == "SB") %>% pull(ASSET),
       FDIC_resources %>% filter(!commented, BKCLASS == "SB") %>% pull(ASSET))
fdic_tSB

fdic_tSA <- t.test(FDIC_resources %>% filter(commented, BKCLASS == "SA") %>% pull(ASSET),
       FDIC_resources %>% filter(!commented, BKCLASS == "SA") %>% pull(ASSET))
fdic_tSA

FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("N")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
  ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
      geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
  scale_x_log10() + 
  labs(title = "National Associations",
       fill = "", y = "", x = "Assets (Thousands)") + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```


#### Dropping National Associations


Now omitting class national associations and foreign banks (Class IO are foreign banks and did not comment)

```{r FDIC-density-select, fig.height=3, fig.width=4, out.width="50%"}
#FDIC-density-select


FDIC_resources %<>% 
  filter(#BKCLASS != "N", 
         BKCLASS != "OI") %>% 
  ungroup() %>% 
  group_by(Commented) %>% 
  mutate(mean_ASSET = mean(ASSET, na.rm =TRUE),
           median_ASSET = median(ASSET, na.rm =TRUE)) 

# density plot without N and OI
FDIC_resources %>%
   densityplot(caption = str_c("Welch t-test of difference in means, p = ", fdic_t$p.value  %>% round(20) %>% signif(1), "\nOmits foreign banks and national associations"))
```

```{r FDIC-count-select, fig.height=3, fig.width=4, out.width="50%"}

FDIC_resources %>% distinct(Commented, mean_ASSET) %>% kable()

FDIC_resources %>%
  filter(ASSET > 10) %>% 
  mutate(Commented = Commented %>% paste0(         
    "\n(median = $", round(median_ASSET/1000000, 2) , " million",
         ", mean = $", round(mean_ASSET/1000000, 1) %>% prettyNum(big.mark = ","), " million)")) %>% 
  ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET/1000)) + 
    geom_vline( aes(xintercept = median_ASSET/1000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = str_c("U.S. Banks, N = ", nrow(FDIC_resources)%>% prettyNum(big.mark = ",")) ,
       fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", fdic_t$p.value  %>% round(20) %>% signif(1), "\nOmits foreign banks and national associations")) + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```

```{r FDIC-count-by-class, fig.height=3,  fig.width=4, out.width="49%"}
FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("NM")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
  ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
    geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
  scale_x_log10() + 
  labs(title = "Commercial Banks",fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", fdic_tNM$p.value  %>% round(20) %>% signif(1)))  + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")

FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("SB")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
    ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
      geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
  scale_x_log10() + 
  labs(title = "Savings Banks",fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", fdic_tSB$p.value  %>% round(20) %>% signif(1)))  + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")


FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("SM")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
    ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
      geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
scale_x_log10() + 
  labs(title = "State Banks",fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", fdic_tSM$p.value  %>% round(20) %>% signif(1)))  + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")

FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("SA")) %>% 
  mutate(Commented = Commented %>% paste0(
         "\n(median = $", round(median_ASSET_type, 0) %>% prettyNum(big.mark = ",") ,
         ", mean = $", round(mean_ASSET_type, 0) %>% prettyNum(big.mark = ","), ")"
    )) %>% 
    ggplot() + 
  aes(x = ASSET/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_ASSET_type/1000)) + 
      geom_vline( aes(xintercept = median_ASSET_type/1000), linetype = 2) +
scale_x_log10() + 
  labs(title = "Savings Associations",fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", fdic_tSA$p.value  %>% round(20) %>% signif(1)))  + 
  facet_wrap("Commented",  scales = "free_y", nrow = 2)+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```

```{r FDIC-density-by-class, fig.height=3,  fig.width=4, out.width="49%"}
FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("NM")) %>% 
  densityplot(
    title = "Commercial Banks",
    x = "Assets (Thousands)",
    caption = str_c("Welch t-test of difference in means, p = ", fdic_tNM$p.value  %>% round(20) %>% signif(1)))
  

FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("SB")) %>% 
  densityplot(title = "Savings Banks", x = "Assets (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", fdic_tSB$p.value  %>% round(20) %>% signif(1)))


FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("SM")) %>% 
  densityplot(title = "State Banks",
              x = "Assets (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", fdic_tSM$p.value  %>% round(20) %>% signif(1)))

FDIC_resources %>%
  filter(ASSET > 10, BKCLASS %in% c("SA")) %>% 
  densityplot(title = "Savings Associations",
              x = "Assets (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", fdic_tSA$p.value  %>% round(20) %>% signif(1)))
```


```{r fdic-map}
states <- ggplot2::map_data("state")

FDIC_state_n <- FDIC_resources %>% 
  mutate(region = STNAME %>% str_to_lower()) %>% 
  group_by(region) %>% 
  summarise(n = n() )

states %>% 
  left_join(FDIC_state_n) %>% 
  ggplot() +
  aes(long, lat, group = group, fill = n) +
  geom_polygon(color = "white") + 
  labs(fill = "Banks") +
  theme_void()


FDIC_state_n <- FDIC_resources %>% 
  mutate(region = STNAME %>% str_to_lower()) %>% 
  group_by(region) %>% 
  summarise(n = sum(Commented == "Commented"))

states %>% 
  left_join(FDIC_state_n) %>% 
  ggplot() +
  aes(long, lat, group = group, fill = n) +
  geom_polygon(color = "white") + 
  labs(fill = "Banks \nCommenting On\n Dodd-Frank Rules") +
  theme_void()


```


---

### Among nonprofits that commented on Dodd-Frank rules

```{r nonprofit-comment-counts, fig.height=3, fig.width=4, out.width="50%"}
# nonprofits in commenter data 
d_nonprofits <- d %>% filter(org_type2 %in% c("Credit Union", "Other Nonprofit"))

# inspect 
nonprofit_resources %>% kablebox()


# select variables we care about for now 
nonprofit_resources %<>% distinct(name, ein, assets, revenue)

# indicator variable for commenting 
nonprofit_resources %<>% mutate(commented = str_to_lower(name) %in% d_nonprofits$org_name | str_to_lower(name) %in% d_nonprofits$organization | ein %in% d_nonprofits$`nonprofits_resources-bestMatch:ein`) #

# join in comment counts 
# nonprofit_resources %<>% left_join(org_count %>% mutate(name = org_name) , n))

# by ein
nonprofit_resources %<>% 
  left_join(
    ein_count %>% 
      dplyr::select(
        ein = `nonprofits_resources-bestMatch:ein`, n)) %>% 
  mutate(n = replace_na(n, 0))


# make unique ( there are nearly 5k different rotary internationals and several APIs )
# select org entry with highest assets 
nonprofit_resources %<>% group_by(name) %>% 
  top_n(1, assets) %>% 
  ungroup()

nonprofit_resources %<>% 
  mutate(Commented = ifelse(commented, "Commented", "Did not comment")) 


nonprofit_resources %>% 
  filter(commented) %>% 
  #filter(commented, assets > 100) %>% 
  ggplot() + 
  aes(x = assets, y = n) + 
  geom_point(alpha = .5) + 
  geom_smooth() + 
    labs(x = "Assets",
         title = str_c("Non-profits, N = ", nrow(nonprofit_resources)),
       y = "Number of Comments") +
  scale_x_log10()+ scale_y_log10()


nonprofit_resources %>% 
  filter(commented, assets > 100) %>% 
  ggplot() + 
  aes(x = revenue, y = n) + 
  geom_point(alpha = .5) + 
  geom_smooth() + 
    labs(x = "Revenue",
         title = str_c("Non-profits, N = ", nrow(nonprofit_resources)),
       y = "Number of Comments") +
  scale_x_log10() + scale_y_log10()
```

---

### Comparing nonprofits that did and did not comment on Dodd-Frank rules

```{r nonprofit-density, fig.height= 3, fig.width=4, out.width="50%"}
# counts 
nonprofit_resources %>% count(Commented) %>% mutate(percent = n/nrow(nonprofit_resources))

nonprofit_t <- t.test(nonprofit_resources %>% filter(commented) %>% pull(assets),
       nonprofit_resources %>% filter(!commented) %>% pull(assets))

nonprofit_t

nonprofit_revenue_t <- t.test(nonprofit_resources %>% filter(commented) %>% pull(revenue),
       nonprofit_resources %>% filter(!commented) %>% pull(revenue))

nonprofit_revenue_t

nonprofit_resources %>% 
  filter(assets > 10) %>% 
  densityplot(var = "assets",
              by = 1000,
              title = "Non-profits",
               x = "Assets (Thousands)",
              caption = str_c("Welch t-test of difference in means, p = ", nonprofit_t$p.value  %>% round(20) %>% signif(1))) 


nonprofit_resources %>% 
  filter(revenue > 10) %>%
  densityplot(var = "revenue",
              by = 1000,
              title = "Non-profits",
               x = "Revenue (Thousands)",
              caption = str_c("Welch t-test of difference in means, p = ", nonprofit_revenue_t$p.value  %>% round(20) %>% signif(1))) 

# old density plots 
nonprofit_resources %>% 
  filter(assets > 10) %>% 
  ggplot() + 
  aes(x = assets/1000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = str_c("Non-profits, N = ", nrow(nonprofit_resources)),
       fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", nonprofit_t$p.value  %>% round(20) %>% signif(1)))  + 
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

# revenue
nonprofit_resources %>% 
    filter(revenue > 10) %>% 
  ggplot() + 
  aes(x = revenue/1000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(fill = "", y = "", x = "Revenue (Thousands)",
       title = str_c("Non-profits, N = ", nrow(nonprofit_resources)),
       caption = str_c("Welch t-test of difference in means, p = ", nonprofit_revenue_t$p.value  %>% round(20) %>% signif(1)))  + 
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())



nonprofit_resources %<>% 
  group_by(Commented) %>% 
  mutate(mean_assets = mean(assets, na.rm = T),
         median_assets = median(assets, na.rm = T),
         mean_revenue = median(revenue, na.rm = T)) %>% 
  ungroup()

nonprofit_resources %>% distinct(Commented, mean_assets, mean_revenue) %>% kable


# mean assets
mean_commented <- nonprofit_resources %>% filter(Commented == "Commented") %>% distinct(mean_assets/1000000) %>% round(1) %>%  paste("million")

mean_not_commented <- nonprofit_resources %>% filter(Commented != "Commented") %>% distinct(mean_assets/1000000) %>% round(1) %>%  paste("million")

# median assets
median_commented <- nonprofit_resources %>% filter(Commented == "Commented") %>% distinct(median_assets/1000000) %>% round(2) %>%  paste("million")

median_not_commented <- nonprofit_resources %>% filter(Commented != "Commented") %>% distinct(median_assets/1000000) %>% round(2) %>%  paste("million")
```


Nonprofits that commented on Dodd-Frank rules had an average of `r mean_commented` in assets, while nonprofits that did not comment averaged `r mean_not_commented`.

The median nonprofits that commented on Dodd-Frank rules had assets of `r median_commented` in assets, while the median nonprofit that did not comment had `r median_not_commented`.

```{r nonprofit-count, fig.height=3, fig.width=4, out.width="50%"}
#nonprofit-count  histograms 
nonprofit_resources %>% 
  filter(assets > 10) %>% 
  mutate(Commented = Commented %>% paste(
    "\n(median = $", round(median_assets/1000000, 2), " million, ",
    "mean = $", round(mean_assets/1000000, 1), " million)"
    )) %>% 
  ggplot() + 
  aes(x = assets/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_assets/1000)) + 
  geom_vline( aes(xintercept = median_assets/1000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = str_c("Non-profits, N = ", nrow(nonprofit_resources) %>% prettyNum(big.mark = ",") ),
       fill = "", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", nonprofit_t$p.value   %>% round(20) %>% signif(1)
                       ))  + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")


nonprofit_resources %>% 
  filter(revenue > 10) %>% 
  ggplot() + 
  aes(x = revenue/1000, fill = Commented, label = mean_revenue) + 
  geom_histogram(alpha = .5, color = NA) + 
    geom_vline( aes(xintercept = mean_revenue/1000)) + 
  scale_x_log10() + 
  labs(title = str_c("Non-profits, N = ", nrow(nonprofit_resources)%>% prettyNum(big.mark = ",")),
       fill = "", y= "", x = "Revenue ($1,000s)",
       caption = str_c("Welch t-test of difference in means, p = ", nonprofit_revenue_t$p.value   %>% round(20) %>% signif(1)
                       ))  + 
  facet_grid(Commented ~ ., scales = "free_y")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_blank(),
  strip.text.y = element_blank())

# CHARTS 
# - who comments, who does not 
# - 


# TODO 
# - biggest nonprofits by assets and revenue (e.eg. chamber )
# - compartaitve ratios at key levels
# - percent nonprofits 
# - side by side histograms
# missing fed in matching, but could compare FDIC regulator to agency commented on
# - scholzman and verba, gilens and bartels 
```

### Comparing credit unions that did and did not comment on Dodd-Frank rules


```{r creditunion-density, fig.height= 3, fig.width=4, out.width="50%"}
#creditunion-density

creditunions %<>% 
  group_by(CU_NAME) %>% 
  top_n(1, `Total Assets`) %>% 
  ungroup()

creditunions %<>% mutate(org_name = tolower(CU_NAME),
                         assets = `Total Assets`,
                         commented = org_name %in% d$best_match_name | org_name %in% d$organization | RSSD %in% d$rssd,
                         Commented = ifelse(commented, "Commented", "Did not comment"))

creditunions %>% count(Commented) %>% mutate(percent = n/nrow(creditunions))

creditunion_t <- t.test(creditunions %>% filter(!commented) %>% pull(assets),
       creditunions %>% filter(commented) %>% pull(assets))
creditunion_t

# density plots 
creditunions %>% 
  filter(assets > 10) %>% 
  densityplot(var = "assets",
              by = 1000000,
              x = "Assets (Millions)",
              title = "Credit Unions", 
              caption = str_c("Welch t-test of difference in means, p = ", creditunion_t$p.value  %>% round(20) %>% signif(1)))
  
#   
# creditunions %>% 
#   filter(assets > 10) %>% 
#   ggplot() + 
#   aes(x = assets/1000000, fill = Commented) + 
#   geom_density(alpha = .5, color = NA) + 
#   scale_x_log10() + 
#   labs(fill = "", x = "Assets (Millions)", 
#        title = str_c("Credit Unions, N = ", nrow(creditunions)%>% prettyNum(big.mark = ",")),
#        fill = "", y = "",
#        caption = str_c("Welch t-test of difference in means, p = ", creditunion_t$p.value  %>% round(20) %>% signif(1)))  + 
#   theme(panel.grid.major.y = element_blank(),
#         panel.grid.minor.y = element_blank(),
#         axis.text.y = element_blank())

```


```{r creditunion-count, fig.height= 3, fig.width=4, out.width="50%"}
# creditunion-count 
creditunions %<>% 
  group_by(Commented) %>% 
  mutate(mean_assets = mean(assets, na.rm = T),
         median_assets = median(assets, na.rm = T) ) %>% 
  ungroup()

creditunions %>% distinct(Commented, mean_assets) %>% kable


# count histograms 
creditunions %>% 
    filter(assets > 100000) %>% 
  mutate(Commented = Commented %>% paste0(
    "\n(median = $", round(median_assets/1000000, 0), " million, ",
    "mean = $", round(mean_assets/1000000, 0), " million)"
    )) %>% 
  ggplot() + 
  aes(x = assets/1000000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_assets/1000000)) + 
    geom_vline( aes(xintercept = median_assets/1000000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = str_c("Credit Unions, N = ", nrow(creditunions)%>% prettyNum(big.mark = ",")),
       fill = "", y = "", x = "Assets (Millions)",
       caption = str_c("Welch t-test of difference in means, p = ", creditunion_t$p.value  %>% round(20) %>% signif(1)))  + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```



---

## By Lobbying Spending

(OpenSecrets data)

TODO: Replicate with LDA Lobbying spending

```{r opensecrets-density, fig.height=3, fig.width=4, out.width="50%"}
#opensecrets-density


# indicator for whether they commented
opensecrets %<>% 
  mutate(org_name = orgName %>% str_to_lower(),
         Commented = ifelse(
     parentID %in% d$parentID | org_name %in% d$best_match_name | org_name %in% d$organization | org_name %in% d$opensecrets_resources_name, # FIXME this name does not exactly match across datasets 
    "Commented", 
    "Did not comment"))

opensecrets %<>% distinct(Commented, parentID,MeanContribAmount,TotalContribAmount,MeanContribAmountPerYearContributed,
                          MeanLobbyingAmount, TotalLobbyingAmount, NYearsLobbying) %>%  
  mutate(commented = Commented == "Commented")


# opensecrets %>% count(org_name, parentID, sort = T)

# # unique
# opensecrets %<>% group_by(org_name, parentID) %>% 
#   top_n(1, MeanContribAmount)

opensecrets %<>% 
  group_by(Commented) %>% 
  mutate(mean_MeanContribAmount = mean(MeanContribAmount, na.rm = T),
         median_MeanContribAmount = median(MeanContribAmount, na.rm = T),
         mean_MeanLobbyingAmount = mean(MeanLobbyingAmount, na.rm = T),
         median_MeanLobbyingAmount = median(MeanLobbyingAmount, na.rm = T)
         #TODO ADD LOBBYING VARS
         ) %>% 
  ungroup()

opensecrets %>% count(Commented, is.na(TotalContribAmount)) %>% mutate(percent = n/nrow(opensecrets))



opensecrets %>% select(Commented, contains("org"), contains("parent"), contains("amount")) %>%  kablebox()

opensecrets_t <- t.test(opensecrets %>% 
         filter(commented) %>% pull(MeanContribAmount),
       opensecrets %>% 
         filter(!commented) %>% pull(MeanContribAmount)
       )

opensecrets_t


opensecrets %>% 
  group_by(Commented) %>% 
  summarise(mean_MeanContribAmount = mean(MeanContribAmount, na.rm = T),
            mean_MeanContribAmountPerYearContributed = mean(MeanContribAmountPerYearContributed, na.rm = T),
            MeanTotalContribAmount = mean(TotalContribAmount, na.rm = T)) %>% 
  kable()



opensecrets %>% 
  densityplot(var = "MeanContribAmount",
              by = 1000,
              title = "Campaign Donors",
              x =  "Mean Contribution ($1,000s, 2010-2017)",
       caption = str_c("Welch t-test of difference in means, p = ", opensecrets_t$p.value  %>% round(20) %>% signif(1))
       )

opensecrets %>% 
  #filter(assets > 10) %>% 
  ggplot() + 
  aes(x = MeanContribAmountPerYearContributed/1000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = str_c("Campaign Donors, N = ", nrow(opensecrets)%>% prettyNum(big.mark = ",")),
       fill = "", 
       y = "",
       x = "Mean Contribution per Year\n($1,000s, 2010-2017)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

opensecrets %>% 
  #filter(assets > 10) %>% 
  ggplot() + 
  aes(x = TotalContribAmount/1000, fill = Commented) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  labs(title = str_c("Campaign Donors, N = ", nrow(opensecrets)%>% prettyNum(big.mark = ",")),
       y = "",
       x = "Total Contributions\n($1,000s, 2010-2017)")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())
```


```{r opensecrets-count, fig.height= 3, fig.width=4, out.width="50%"}
# opensecrets-count 

# count histograms
opensecrets %>% 
    filter(MeanContribAmount > 100) %>% 
  mutate(Commented = Commented %>% paste0(
    "\n(median = $", round(median_MeanContribAmount/1000, 0), " thousand, ",
    "mean = $", round(mean_MeanContribAmount/1000, 0), " thousand)"
    )) %>% 
  ggplot() + 
  aes(x = MeanContribAmount/1000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_MeanContribAmount/1000)) + 
    geom_vline( aes(xintercept = median_MeanContribAmount/1000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = str_c("Campaign Donors, N = ", nrow(opensecrets)%>% prettyNum(big.mark = ",")),
       fill = "", y = "", x = "Political Action Committee Donations (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", opensecrets_t$p.value %>% round(20) %>%  signif(1))
       ) + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```

---

## By Market Cap

### Computstat data

```{r}
d$cik %>% nchar() %>% unique()

# make cik 10 digets to be consistent 
d$cik %<>% str_squish() %>% as.numeric() %>% formatC(width = 10, format = "d", flag = "0") 

# companies in commenter data 
d_companies = d %>% filter(org_type2 %in% c("Bank", "Other Company"))


compustat$cik %>% nchar() %>% unique()

# WE CANT JUST MERGE ON CIK
compustat %>% filter(is.na(cik))

# make cik 10 digets to be consistent 
compustat$cik %<>% str_squish() %>% as.numeric() %>%  formatC(width = 10, format = "d", flag = "0") 

# compustat %>% filter(is.na(cik))
# compustat %>% filter(cik =="        NA") %>% nrow()

# drop NA 
compustat %<>% filter(cik !="        NA") 

compustat %>% kablebox()
```


### CIK data

```{r}
cik$cik %>% nchar() %>% unique()

cik %>% filter(is.na(cik))

cik$cik %<>% str_squish() %>% as.numeric() %>% formatC(width = 10, format = "d", flag = "0") 

# drop NA 
cik %<>% filter(cik !="        NA") 
cik %<>% drop_na(cik)

# join in marketcap from compustat 
cik %<>%
  left_join(compustat %>% 
              select(cik, marketcap)
            )

cik %>% filter(is.na(cik))


cik %<>% drop_na(marketcap, cik)  

cik %<>% select(-`...1`) %>% distinct()

cik %>% kablebox()
```


### SEC data

```{r}
sec$cik %>% nchar() %>% unique()

# make cik 10 digets to be consistent 
sec$cik %<>% as.numeric() %>% formatC(width = 10, format = "d", flag = "0") 
# drop NA 
sec %<>% filter(cik !="        NA") 

sec$cik %>% nchar() %>% unique()


# join in marketcap from compustat 
sec %<>%
  left_join(compustat %>% 
              distinct(cik, marketcap)
            )
# drop NA 
sec %<>% filter(cik !="        NA") 
sec %<>% drop_na(marketcap, cik)  

sec %<>% distinct()

sec %>% kablebox()
```


### Combined
```{r}
#CIK NOW HAS MATCHES, THEY ARE COMBINED HERE 

# drop NA 
compustat %<>% filter(cik !="        NA") 

# JOIN COMPUSTAT, SEC, and CIK metadata
compustat %<>% full_join(cik %>% select(cik, company_name, marketcap)) %>% distinct()

compustat %<>% full_join(sec %>% select(cik, Name, marketcap)) %>% distinct()

# drop NA 
compustat %<>% filter(cik !="        NA") 

compustat %>% filter(is.na(cik) | is.na(marketcap)) %>% kablebox()


compustat %<>% drop_na(marketcap, cik)   %>%  distinct()


d_companies %>%  count(cik, best_match_name, comment_org_name, sort = T) %>% 
  left_join(compustat %>% distinct(marketcap, cik)) %>% distinct() %>% kablebox()

# look for missing market cap observations 
compustat %>% filter(str_detect(cik, "1023398|713095|849116|1051871|NA"))

# look for missing cik observations
compustat %>% filter(str_detect(conm, "MBMI RESOURCES INC"))

compustat_broader_cik <- compustat %>% mutate(
  org_name = coalesce(conm, company_name, Name) %>% str_to_lower(),
  commented = cik %in% d_companies$cik | org_name %in% d_companies$organization | org_name %in% d_companies$best_match_name | org_name %in% d_companies$compustat_resources_name) %>% 
  filter(commented) %>% pull(cik)

compustat %<>% mutate(
  org_name = coalesce(conm, company_name, Name) %>% str_to_lower(),
  commented = cik %in% d_companies$cik | org_name %in% d_companies$organization | org_name %in% d_companies$best_match_name,# | org_name %in% d_companies$compustat_resources_name, #FIXME decide if we want to mach on compusat_resources_name as well as best match name 
  Commented = ifelse(commented, "Commented", "Did not comment")
)

compustat_narrow_cik <- compustat %>% filter(commented) %>% pull(cik)

# inspect cases that we will not include if we go with the narrower match 
d %>% filter(cik %in% compustat_broader_cik,
             !cik %in% compustat_narrow_cik
             ) %>% select(contains("name"), contains("cik") )  %>% 
  kablebox()

compustat %>% count(commented)

compustat %<>% 
  mutate(
         marketcap2 = ifelse(str_detect(marketcap, "k"),
                             marketcap %>% str_remove("k") %>% as.numeric() * 1000,
                             marketcap),
         marketcap2 = ifelse(str_detect(marketcap, "M"),
                             marketcap %>% str_remove("M") %>% as.numeric() * 1000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "B"),
                             marketcap %>% str_remove("B") %>% as.numeric() * 1000000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "T"),
                             marketcap %>% str_remove("T") %>% as.numeric() * 1000000000000,
                             marketcap2),
         marketcap2 = marketcap2 %>% str_remove(",") %>%  as.numeric(marketcap2))

compustat %>% count(org_name,cik,marketcap, marketcap2, sort = T) %>% 
  # arrange(marketcap) %>%
  kablebox()
```


### Min and max market cap

```{r}
compustat %>% distinct(conm, tic, cik, marketcap, marketcap2, Commented) %>%  arrange(marketcap2) %>% kablebox()

compustat %>% distinct(conm, tic, cik, marketcap, marketcap2, Commented) %>%  arrange(-marketcap2) %>% kablebox()
```

### Commenters by min and max market cap

```{r}
compustat %>% filter(commented) %>% distinct(conm, tic, cik, marketcap, marketcap2, Commented) %>%  arrange(marketcap2) %>% kablebox()

compustat %>% filter(commented) %>% distinct(conm, tic, cik, marketcap, marketcap2, Commented) %>%  arrange(-marketcap2) %>% kablebox()

compustat %<>% distinct(org_name,cik,marketcap, marketcap2, commented, Commented, naics)
```

### Plots
```{r compustat-density, fig.height=3, fig.width=4, out.width="50%"}

#compustat %>% filter(is.na(marketcap2), !is.na(marketcap)) %>% pull(marketcap)

# unique
compustat %<>% group_by(cik) %>% 
  top_n(1, marketcap2) %>% 
  ungroup() 


compustat %>% count(Commented) %>% mutate(percent = n/nrow(compustat))

compustat %>% filter(commented) %>% 
  left_join(d) %>%
  select(org_name, marketcap, comment_url) %>% 
  group_by(org_name) %>% 
  slice_head(n = 1) %>% 
  kablebox()

compustat_t <- t.test(compustat %>% filter(commented) %>% pull(marketcap2),
       compustat %>% filter(!commented) %>% pull(marketcap2))

compustat_t

compustat %>% 
  filter(marketcap2 > 1000) %>% 
  densityplot(var = "marketcap2",
              by = 1000000, 
              title = "Publicly-traded Companies",
       x = "Market Capitalization (Millions)",
       caption = str_c("Welch t-test of difference in means, p = ", compustat_t$p.value  %>% round(20) %>% signif(1) )
       )
```

```{r compustat-count, fig.height= 3, fig.width=4, out.width="50%"}
# compustat-count 
compustat %<>% 
  group_by(Commented) %>% 
  mutate(mean_marketcap2 = mean(marketcap2, na.rm = T),
         median_marketcap2 = median(marketcap2, na.rm = T) ) %>% 
  ungroup()

compustat %>% distinct(Commented, mean_marketcap2) %>% kable


# count histograms
compustat %>% 
    filter(marketcap2 > 1000) %>% 
  mutate(Commented = Commented %>% paste0(
    "\n(median = $", round(median_marketcap2/1000000000, 1), " billion, ",
    "mean = $", round(mean_marketcap2/1000000000, 1), " billion)"
    )) %>% 
  ggplot() + 
  aes(x = marketcap2/1000000, fill = Commented, color = Commented) + 
  geom_histogram(alpha = .5, color = NA) + 
  geom_vline( aes(xintercept = mean_marketcap2/1000000)) + 
    geom_vline( aes(xintercept = median_marketcap2/1000000), linetype = 2) + 
  scale_x_log10() + 
  labs(title = str_c("Publicly-traded Companies, N = ", nrow(compustat)%>% prettyNum(big.mark = ",")),
       fill = "", y = "", x = "Market Cap (Millions)",
       caption = str_c("Welch t-test of difference in means, p = ", compustat_t$p.value  %>% round(20) %>% signif(1))
       ) + 
  facet_wrap("Commented", ncol = 1, scales = "free_y", strip.position = "top")+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
```




# Post-hoc corrections 

```{r posthoc}
# FIXME 
# A FEW IMPORTANT  POST HOC CORRECTIONS 
nonprofit_resources %>% filter(str_dct(name, "chamber of commerce")) %>%
  mutate(name = str_to_lower(name) )%>% 
  arrange(-assets) %>% 
           kablebox()

# FIXME correct ParentID 
# opensecrets %>% filter(str_dct(org_name, "chamber of commerce")) %>%
#   arrange(-TotalContribAmount) %>% 
#            kablebox()

d %>% filter(str_dct(org_name, "chamber")) %>%
  distinct(organization, comment_org_name, org_name, ein) %>% 
           kablebox()

d %<>% 
  mutate(ein = ifelse(comment_org_name %in% c("us chamber commerce", "chamber commerce"), 
                       530045720,
                       ein),
         org_name = ifelse(comment_org_name %in% c("us chamber commerce", "chamber commerce"), 
                       "us chamber of commerce",
                       org_name))


# API 
nonprofit_resources %>% filter(str_dct(name, "petroleum institute")) %>%
  mutate(name = str_to_lower(name) )%>% 
  arrange(-assets) %>% 
           kablebox()

d %>% filter(str_dct(org_name, "petroleum institute")) %>%
  distinct(organization, comment_org_name, org_name, ein) %>% 
           kablebox()

# FIXME correct ParentID 
# opensecrets %>% filter(str_dct(org_name, "petroleum institute")) %>%
#   arrange(-TotalContribAmount) %>% 
#            kablebox()


d %<>% 
  mutate(ein = ifelse(comment_org_name %in% c("petroleum institute", "petroleum institute"), 
                       130433430,
                       ein),
         org_name = ifelse(comment_org_name %in% c("petroleum institute", "petroleum institute"), 
                       "american petroleum institute",
                       org_name)
         )

```



# Merging in asset data 

```{r merge}
#FIXME 
# WE SHOULD NOT BE MERGING ON ORG NAME UNLESS IT IS A UNIQUE ID
# AS OF 20-04-2023, org name is not the same as the names in these datasets, so I'm merging nonprofits on ein

# check for unique ides
FDIC_resources %>% count(CERT, sort = T)

# import FDIC ASSET Var to d 
d %<>% 
  left_join(FDIC_resources %>% 
                   ungroup() %>% 
              select(CERT, ASSET))


# orgs in the comment data
d %>% filter(str_detect(best_match_name, "jpmorgan|wells fargo|^bank of america|capital one|td bank|chase bank")) %>% distinct(organization, best_match_name, `ASSET`) %>% 
  kablebox()


# LOBBYING AND PAC DATA 
# opensecrets %>% count(org_name,sort = T)
sum_smart <- function(x) {sum(x, na.rm = T)}

opensecrets %>% 
  drop_na(parentID) %>% 
  group_by(parentID, commented, Commented) %>% 
  mutate_all(sum_smart) %>%
  distinct(parentID,
           MeanLobbyingAmount, 
           TotalLobbyingAmount,
           MeanContribAmount, TotalContribAmount, 
           MeanContribAmountPerYearContributed
           ) %>%  
  count(parentID, sort = T)

d %<>% 
  left_join(
    #opensecrets %>% drop_na(org_name) %>%  distinct(org_name, MeanContribAmount, TotalContribAmount, MeanContribAmountPerYearContributed)  
        opensecrets %>% 
  drop_na(parentID) %>% 
  group_by(parentID, commented, Commented) %>% 
  mutate_all(sum_smart) %>%
    ungroup() %>% 
  distinct(parentID,
           MeanLobbyingAmount, 
           TotalLobbyingAmount,
           MeanContribAmount, TotalContribAmount, 
           MeanContribAmountPerYearContributed
           ) %>%
    ungroup()
    ) 

d %<>% 
  left_join(
    nonprofit_resources %>% ungroup() %>%  drop_na(ein) %>% 
      dplyr::select(`nonprofits_resources-bestMatch:ein` = ein, assets, revenue) ) 

# check for unique CIK ids
compustat %>% distinct(marketcap, cik) %>%  count(cik, sort = T)
# compustat %>% count(org_name, cik, sort = T)
# compustat %>% distinct(org_name, cik, marketcap, naics, sort = T)

## ALREADY MERGED CIK and SEC ABOVE WHEN LOADING COMPUSTAT 
d %>% count(cik, sort = T)

compustat %>% count(cik, sort = T)

# check for na cik, which will cause false merges 
compustat %>% filter(cik == "        NA") 

d %<>% 
  mutate(cik = ifelse(org_type2 %in% c("Bank", "Other Company"), cik, NA)) %>% 
  left_join(
    compustat %>% ungroup() %>% distinct(cik, marketcap, marketcap2, naics) %>% drop_na(marketcap2)
    ) 

d %>% distinct(org_name, cik, marketcap, marketcap2) %>% 
  arrange(marketcap2) %>% drop_na(marketcap2) %>% kablebox()

creditunions %>% count(RSSD, sort = T)

d %>% distinct(rssd)

d %<>%  
  left_join(
    creditunions %>% ungroup() %>% drop_na(RSSD) %>% mutate(rssd = RSSD) %>% 
      dplyr::select(rssd, `Total Assets`)) 

# inspect credit union matches 

d %>% drop_na(`Total Assets`, rssd) %>% select(rssd, contains("name")) %>% kablebox()


d %<>% distinct()
```


We have market cap for  `r d %>% filter(!is.na(marketcap)) %>% count(best_match_name)  %>% nrow()` companies that submitted `r nrow(d %>% filter(!is.na(marketcap)))` comments.

```{r marketcap-inspect}

# fishy
d %>% 
  ggplot() +
  aes(x = marketcap2) + 
  geom_histogram()

d %>% arrange(-marketcap2) %>% count(marketcap, marketcap2, best_match_name, sort = T) %>% filter(!is.na(marketcap)) %>% kablebox()
d %>% drop_na(marketcap) %>% select(contains("name")) %>% kablebox()

# d %>% filter(marketcap == "2.413T") %>% select(contains("name")) %>% kablebox()

# unique(d$marketcap)
```



---

## Duplicates

(more than one match per comment URL)

Orgs in multiple states were one problem. For example, the API incorporated in DC has \$128,273,933 in assets while API in TX has \$15,368. Yale University had \$27,801,734,697 in assets (must include the endowment), and another Yale University had $4,858,646, both in CT.

```{r duplicates}

d %<>% distinct()
# duplicates
d %>% 
  add_count(comment_url, name = "n_per_url", sort = T) %>% 
  ungroup() %>% 
  filter(n_per_url > 1) %>% distinct() %>% 
  arrange(comment_url) %>%
  kablebox()
```

We solved this by selecting the entry with the highest assets. For example, the API now only matches the API's DC location. 

However, in the prior version of the data, the American Petroleum Institute and Yale University were both matched to nonprofit asset data and to opensecrets. Now, Yale Law has opensecrets data but no asset data, while API has asset data but no campaign donations. Yale University has neither -- it is matched in CIK data, but its marketcap is NA, so we now have nothing for it. 

```{r}
d %<>% distinct()

d %>% filter(str_detect(best_match_name, "petroleum inst|yale uni")) %>% # view
  dplyr::select(comment_url, best_match_name, 
         assets, 
         revenue,
         `nonprofits_resources-bestMatch:ein`,
         opensecrets_resources_name,
         MeanContribAmount,
         CIK_name,
         marketcap
         ) %>% 
  kablebox()
```

<!--
But we still have almost as many duplicates when we drop `state`, partially because assets vary for the same "org" registered in different states: 

```{r duplicates2, eval = FALSE }
# duplicates after removing state
d %>% 
  dplyr::select(-state) %>%
  add_count(comment_url, name = "n_per_url") %>% 
  ungroup() %>% 
  filter(n_per_url > 1) %>% distinct() %>% 
  arrange(comment_url) %>%
  kablebox()
```

--> 

## Asset data coverage by docket

```{r}
is_not_na <- . %>% is.na() %>% isFALSE()


dtable <- d_rin_lookup %>%
  ungroup() %>% 
  full_join(d %>% dplyr::select(docket_id, comment_url, ends_with("_name"))) %>%
  ungroup() %>% 
  # add_count(docket_id) %>% 
  group_by(comment_url) %>% 
  mutate(across(ends_with("name"), is_not_na)) %>% 
  mutate(asset_data_name = sum( CIK_name, CreditUnions_name, FDIC_Institutions_name,	FFIECInstitutions_name,	SEC_Institutions_name,	compustat_resources_name,	nonprofits_resources_name) > 0#,
         #unique_orgs_name = org_name %>% unique() %>% length() 
         ) %>% 
  dplyr::select(docket_id, comment_count, comments_matched, lowest.sorted.rin.of.related.rins,related.rins,
         comment_url, ends_with("_name")) %>% 
  distinct() %>% 
  group_by(docket_id, comment_count, comments_matched, lowest.sorted.rin.of.related.rins,related.rins) %>% 
  # tally up matches
  summarise(across(ends_with("name"), sum)) %>% 
  # select vars for table 
  dplyr::select(docket_id,  lowest.sorted.rin.of.related.rins,related.rins, comment_count, comments_matched, asset_data_name,
         #unique_orgs_name,
        nonprofits_resources_name,
         CIK_name, CreditUnions_name, FDIC_Institutions_name,	FFIECInstitutions_name,	SEC_Institutions_name,	compustat_resources_name) %>% 
  ungroup() %>%
  distinct() %>% 
  arrange(-asset_data_name) 



sum2 <- . %>% sum(na.rm = TRUE)

dtable %>% summarise(across(where(is.numeric), sum2)) %>% pivot_longer(everything(), names_to = "measure") %>% kable()
  
dtable %>% write_csv(here::here("data", "matches_per_rin.csv"))
```

## Volunteers 

```{r}
irs <- read_csv(here::here("data", "irs_990_xmls_2015.csv")) %>% 
  mutate(`nonprofits_resources-bestMatch:ein` = as.numeric(EIN))

irs %<>% distinct(`nonprofits_resources-bestMatch:ein`, TotalVolunteersCnt, TotalEmployeeCnt, WebsiteAddressTxt) 

irs %<>% group_by(`nonprofits_resources-bestMatch:ein`) %>% arrange(-TotalEmployeeCnt) %>% arrange(-TotalVolunteersCnt) %>% slice_head(n = 1) %>% ungroup() 

d %<>% left_join(irs)
```


## Save asset data
```{r save}
#FIXME ideally, all edits to these data would be in clean_asset_data.R
# however, that requires knowing all of the asset data we want 

# market cap

d  %<>% mutate(
         marketcap2 = ifelse(str_detect(marketcap, "k"),
                             marketcap %>% str_remove("k") %>% as.numeric() * 1000,
                             marketcap %>%  str_remove(",")),
         marketcap2 = ifelse(str_detect(marketcap, "M"),
                             marketcap %>% str_remove("M") %>% as.numeric() * 1000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "B"),
                             marketcap %>% str_remove("B") %>% as.numeric() * 1000000000,
                             marketcap2),
         marketcap2 = ifelse(str_detect(marketcap, "T"),
                             marketcap %>% str_remove("T") %>% as.numeric() * 1000000000000,
                             marketcap2),
         marketcap2 = marketcap2 %>% 
           str_remove(",") %>%  
           as.numeric(marketcap2))

d %>% distinct(marketcap, marketcap2) %>% kablebox()

# NAMING THINGS
#FIXME This is dumb
d %<>% mutate(
              org_resources = coalesce(
                `assets` %>% as.numeric(),
                `ASSET` %>% as.numeric(),
                `marketcap2` %>% as.numeric(),
                `Total Assets` %>% as.numeric()))

d%>% count(is.na(org_resources))

commenter_assets <- d 

n_orgs <- d$org_name %>% unique() %>% length()

# + non-commenters 
n_orgs_total <- c(FDIC_resources$org_name,
  nonprofit_resources$org_name,
  opensecrets$org_name,
  compustat$org_name) %>% 
  unique() %>% 
  length()

n_assets <- nrow(d)

save(commenter_assets, 
     n_orgs, n_orgs_total, 
     n_assets,
     n_rules,
     n_actions,
     file = here::here("data", "commenter_assets.Rdata"))
```

---

# Frequency of participation among organizations that commented

Among commenting organizations, how many rules did each comment on?

WARNING: THIS IS A PROBLEMATIC MEAURE BECAUSE MARKET CAP AND NGO ASSETS ARE NOT AT ALL THE SAME 

```{r asset-counts, fig.width=4, fig.height= 2, out.width= "50%"}
asset_counts <- d %>% 
  mutate(assets = org_resources) %>% 
  filter(assets > 10) %>%
  distinct(org_name, docket_id, assets) %>% 
  count(org_name, assets) %>% 
  filter(!is.na(assets)) %>% 
  mutate(nnp = quantile(n, probs = .9),
         assets_m = assets /1000000,
         assets_b = assets_m / 1000,
         onepercent = ifelse(n > nnp, "Top 10%", "Bottom 90%"),
         five = ifelse(n < 5, "<5 Rules", "5 or More Rules"),
         top = n > nnp)

rules_t <- t.test(asset_counts %>% filter(top) %>% pull(assets),
                  asset_counts %>% filter(!top) %>% pull(assets),)

rules_t

asset_counts %>% 
  ggplot() + 
  aes(x = n,  fill = onepercent) + 
  geom_bar() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Banks and Non-profits" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       y = "Number of Organizations",
       fill = "Frequency of\nCommenting",
       x = "Dodd-Frank Rules per Organization") #+ scale_y_log10()


asset_counts %>% 
  ggplot() + 
  aes(x = assets_m, fill = five) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Banks and Non-profits" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       y = "", 
       x = "Assets (Millions)")+
  scale_fill_viridis_d(begin = .3, end = .9) +  
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

  

asset_counts %>% 
  ggplot() + 
  aes(x = assets_m, fill = onepercent) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Banks and Non-profits" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       y = "", 
       x = "Assets (Millions)")+
  scale_fill_viridis_d(begin = .3, end = .9) +  
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())




m_asset_count <- lm(n ~ assets_b, data = asset_counts)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Number of Rules",
)

attr(rows, 'position') <- c(0)

modelsummary(m_asset_count)
```


For every additional 10 billion in assets, an organization comments on about `r round(m_asset_count$coefficients[2]* 10,0) ` additional rules. 

---

## Among nonprofits that commented on a Dodd-Frank rule

```{r nonprofit-rules, fig.width=4, fig.height= 2, out.width= "50%"}
asset_counts <- d %>% 
  filter(assets > 10) %>%
  distinct(org_name, docket_id, assets) %>% 
  count(org_name, assets) %>% 
  filter(!is.na(assets)) %>% 
  mutate(nnp = quantile(n, probs = .9),
         assets_t = assets / 1000,
         assets_m = assets_t /1000,
         assets_b = assets_m / 1000,
         onepercent = ifelse(n > nnp, "Top 10%", "Bottom 90%"),
         five = ifelse(n < 5, "<5 Rules", "5 or More Rules"),
         top = n > nnp)

asset_counts %>% filter(onepercent == "Top 1%") %>% distinct(n) %>% min()

rules_nonprofits_t <- t.test(asset_counts %>% filter(top) %>% pull(assets),
                  asset_counts %>% filter(!top) %>% pull(assets),)

rules_nonprofits_t 

asset_counts %>% 
  ggplot() + 
  aes(x = n, fill = onepercent) + 
  geom_bar() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Non-profits" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       y = "Number of Non-profits",
       fill = "Frequency of\nCommenting",
       x = "Number of Dodd-Frank Rules") # + scale_y_log10()

asset_counts %>% 
  ggplot() + 
  aes(x = assets_t, fill = five) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Non-profits" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
        fill = "Frequency of\nCommenting", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", rules_nonprofits_t$p.value  %>% round(20) %>% signif(1)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())
  

asset_counts %>% 
  ggplot() + 
  aes(x = assets_t, fill = onepercent) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Non-profits" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
        fill = "Frequency of\nCommenting", y = "", x = "Assets (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", rules_nonprofits_t$p.value  %>% round(20) %>% signif(1)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


m_nonprofit_count <- lm(n ~ assets_b, data = asset_counts)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Number of Dodd-Frank Rules",
)

attr(rows, 'position') <- c(0)

modelsummary(m_nonprofit_count)
```


For every additional 10 billion in assets, a nonprofit comments on about `r round(m_nonprofit_count$coefficients[2]* 10,1) ` additional rules. 

---

## Among  Banks that commented on a Dodd-Frank rule

```{r fdic-rules, fig.width=4,  fig.height= 2,out.width= "50%"}
asset_counts <- d %>% 
  mutate(assets = ASSET) %>% 
  filter(assets > 10) %>%
  distinct(org_name, docket_id, assets) %>% 
  count(org_name, assets) %>% 
  filter(!is.na(assets)) %>% 
  mutate(nnp = quantile(n, probs = .90),
         assets_t = assets /1000,
         assets_m = assets_t /1000,
         assets_b = assets_m / 1000,
         onepercent = ifelse(n > nnp, "Top 10%", "Bottom 90%"),
         five = ifelse(n < 5, "<5 Rules", "5 or More Rules"),
         top = n>nnp)

rules_fdic_t <- t.test(asset_counts %>% filter(top) %>% pull(assets),
                  asset_counts %>% filter(!top) %>% pull(assets),)

rules_fdic_t 

asset_counts %>% 
  ggplot() + 
  aes(x = n, fill = onepercent) + 
  geom_bar() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(y = "Number of Banks",
       title = "Banks" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       x = "Number of Dodd-Frank Rules") #+ scale_y_log10()
  
asset_counts %>% 
  ggplot() + 
  aes(x = assets_m, fill = five) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Banks" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       y = "", x = "Assets (Millions)",
       caption = str_c("Welch t-test of difference in means, p = ", rules_fdic_t$p.value  %>% round(20) %>% signif(1)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

asset_counts %>% 
  ggplot() + 
  aes(x = assets_m, fill = onepercent) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Banks" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       y = "", x = "Assets (Millions)",
       caption = str_c("Welch t-test of difference in means, p = ", rules_fdic_t$p.value  %>% round(20) %>% signif(1)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


m_fdic_count <- lm(n ~ assets_b, data = asset_counts)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Number of Dodd-Frank Rules"
  )

attr(rows, 'position') <- c(0)

modelsummary(list(m_fdic_count))
```


For every additional billion in assets, a bank comments on about `r round(m_fdic_count$coefficients[2]* 1,0) ` additional rules. 


---



## Among credit unions that commented on a Dodd-Frank rule

```{r creditunion-rules, fig.width=4,  fig.height= 2,out.width= "50%"}
asset_counts <- d %>% 
  mutate(assets = `Total Assets`) %>% # credit union call reports Total Assets
  filter(assets > 10, !is.na(assets)) %>%
  distinct(org_name, docket_id, assets) %>% 
  count(org_name, assets) %>% 
  mutate(nnp = quantile(n, probs = .9),
         assets_t = assets /1000,
         assets_m = assets_t /1000,
         assets_b = assets_m / 1000,
         onepercent = ifelse(n > nnp, "Top 10%", "Bottom 90%"),
         five = ifelse(n < 5, "<5 Rules", "5 or More Rules"),
         top = n>nnp)

rules_creditunion_t <- t.test(asset_counts %>% filter(top) %>% pull(assets),
                  asset_counts %>% filter(!top) %>% pull(assets),)

rules_creditunion_t

asset_counts %>% 
  ggplot() + 
  aes(x = n, fill = onepercent) + 
  geom_bar() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(y = "Number of Credit Unions",
       title = "Credit Unions" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       x = "Number of Dodd-Frank Rules") #+ scale_y_log10()
  
asset_counts %>% 
  ggplot() + 
  aes(x = assets_m, fill = five) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Credit Unions" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       y = "", x = "Assets (Millions)",
       caption = str_c("Welch t-test of difference in means, p = ", rules_creditunion_t$p.value  %>% round(20) %>% signif(1)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())

asset_counts %>% 
  ggplot() + 
  aes(x = assets_m, fill = onepercent) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Credit Unions" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       y = "", x = "Assets (Millions)",
       caption = str_c("Welch t-test of difference in means, p = ", rules_creditunion_t$p.value  %>% round(20) %>% signif(1)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


m_creditunion_count <- lm(n ~ assets_b, data = asset_counts)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Number of Dodd-Frank Rules"
  )

attr(rows, 'position') <- c(0)

modelsummary(list(m_creditunion_count))
```


For every additional 10 billion in assets, a credit union comments on about `r round(m_creditunion_count$coefficients[2]* 10,0) ` additional rules. 


---


## Among publicly-traded companies that commented on a Dodd-Frank rule

```{r compustat-rules, fig.width=4, fig.height= 2, out.width= "50%"}
# compustat-rules
d %>% count(org_name, marketcap, sort = T) %>% drop_na(marketcap) %>%  kablebox()
d %>% count(org_name, organization, marketcap, sort = T) %>% drop_na(marketcap) %>%  kablebox()
d %>% filter(org_name == "alternative asset management acquisition") %>% select(marketcap, organization,contains("name")) %>% kablebox()

# combine and count 
asset_counts <- d %>% 
  mutate(marketcap = marketcap2) %>% 
  filter(marketcap > 10) %>%
  distinct(org_name, docket_id, marketcap) %>% 
  count(org_name, marketcap) %>% 
  filter(!is.na(marketcap)) %>% 
  mutate(nnp = quantile(n, probs = .9),
         marketcap_t = marketcap /1000,
         marketcap_m = marketcap_t /1000,
         marketcap_b = marketcap_m / 1000,
         onepercent = ifelse(n > nnp, "Top 10%", "Bottom 90%"),
         five = ifelse(n < 5, "<5 Rules", "5 or More Rules"),
         top = n > nnp)

asset_counts %>% filter(n > 5) %>% count(marketcap, sort = T)
d %>% count(marketcap, sort = T)
compustat %>% count(marketcap, sort = T)
d %>% filter(marketcap2 == 34297000000) %>% select(marketcap, contains("name"), contains("cik"), contains("rssd")) %>% distinct() %>% kablebox()
compustat%>% filter(marketcap2 == 34297000000) 

#FIXME we need to correct this to be a nonprofit, just dropping for now 
asset_counts %<>% filter(org_name != "alternative asset management acquisition")


rules_compustat_t <- t.test(asset_counts %>% filter(top) %>% pull(marketcap),
                  asset_counts %>% filter(!top) %>% pull(marketcap),)

rules_compustat_t 

asset_counts %>% 
  ggplot() + 
  aes(x = n, fill = onepercent) + 
  geom_bar() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(y = "Number of Companies",
       title = "Publicly-Traded Companies" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting",
       x = "Number of Dodd-Frank Rules") #+ scale_y_log10()
  
asset_counts %>% 
  ggplot() + 
  aes(x = marketcap_b, fill = five) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Publicly-Traded Companies" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting", y = "", x = "Market Cap (Billions)",
       caption = str_c("Welch t-test of difference in means, p = ", rules_compustat_t$p.value  %>% round(20) %>% signif(1)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


asset_counts %>% 
  ggplot() + 
  aes(x = marketcap_b, fill = onepercent) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Publicly-Traded Companies" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       fill = "Frequency of\nCommenting", y = "", x = "Market Cap (Billions)",
       caption = str_c("Welch t-test of difference in means, p = ", rules_compustat_t$p.value  %>% round(20) %>% signif(1)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


m_compustat_count <- lm(n ~ marketcap_b, data = asset_counts)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Number of Dodd-Frank Rules"
  )

attr(rows, 'position') <- c(0)

modelsummary(list(m_compustat_count))
```


For every additional 100 billion in market cap, a company comments on about `r round(m_compustat_count$coefficients[2]* 100,0) ` additional rules. 

---

## Among campaign donors that commented on a Dodd-Frank rule

TODO: 
- [ ] Lobbying expendature
- [ ] Versions of PAC donations and lobbying expendature that replace NA with 0 (on the assumption that if they failed to match in CRP, they are not a PAC donor or registered with LDA)

```{r opensecrets-rules, fig.width=4, fig.height= 2, out.width= "50%"}
asset_counts <- d %>% 
  mutate(donations = `MeanContribAmount`) %>% 
   # mutate(donations = `MeanContribAmountPerYearContributed`) %>% 
  filter(donations > 10) %>%
  distinct(org_name, docket_id, donations) %>% 
  count(org_name, donations) %>% 
  filter(!is.na(donations)) %>% 
  mutate(nnp = quantile(n, probs = .9),
         donations_m = donations / 1000000,
         onepercent = ifelse(n > nnp, "Top 10%", "Bottom 90%"),
         five = ifelse(n < 5, "<5 Rules", "5 or More Rules"),
         top = n>nnp)

rules_pac_t <- t.test(asset_counts %>% filter(top) %>% pull(donations),
                  asset_counts %>% filter(!top) %>% pull(donations),)

rules_pac_t 


asset_counts %>% 
  ggplot() + 
  aes(x = n, fill = onepercent) + 
  geom_bar() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Campaign Donors" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
       y = "Number of Organizations",
        fill = "Frequency of\nCommenting",
       x = "Number of Dodd-Frank Rules") #+ scale_y_log10()
  

asset_counts %>% 
  ggplot() + 
  aes(x = donations_m, fill = five) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Campaign Donors" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
        fill = "Frequency of\nCommenting", 
       y = "", x = "PAC Donations (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", rules_pac_t$p.value  %>% round(20) %>% signif(1)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


asset_counts %>% 
  ggplot() + 
  aes(x = donations_m, fill = onepercent) + 
  geom_density(alpha = .5, color = NA) + 
  scale_x_log10() + 
  scale_fill_viridis_d(begin = .3, end = .9) +  
  labs(title = "Campaign Donors" %>% str_c(", N = ", nrow(asset_counts) %>% prettyNum(big.mark = ",")),
        fill = "Frequency of\nCommenting", 
       y = "", x = "PAC Donations (Thousands)",
       caption = str_c("Welch t-test of difference in means, p = ", rules_pac_t$p.value  %>% round(20) %>% signif(1)))+
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_blank())


m_opensecrets_count <- lm(n ~ donations_m, data = asset_counts)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Number of Dodd-Frank Rules",
)

attr(rows, 'position') <- c(0)

modelsummary(m_opensecrets_count)
```


For every additional 10 million in Political Action Committee campaign donations, an organization comments on about `r round(m_opensecrets_count$coefficients[2]* 10,0) ` additional rules. 

---

## All

```{r all-rules}

models <- list(#`All` = m_asset_count, 
               `Non-profits` = m_nonprofit_count,
               `Credit Unions`= m_creditunion_count,
               `Public Companies` = m_compustat_count,
               `Banks` = m_fdic_count,
               `PAC Donors` = m_opensecrets_count)

rows <- tibble(
  term = c("Dependent Variable"),
  #`All` = "Number of Rules",
      `Non-profits` = "Number of Rules",
  `Credit Unions`= "Number of Rules",
  `Public Companies` = "Number of Rules",
  `Banks` = "Number of Rules",
    `PAC Donors` = "Number of Rules",
  )

attr(rows, 'position') <- c(0)


modelsummary(models)

save(models, rows, 
     file = here::here("models", "rules-by-assets.Rdata"))
```

---

## Comments per rule

### Percent of comments by each organization type on any one rule
```{r}
# comments 
# of the matched sample 
# 90% of credit union comments, half of the nonprofits, and 75% campaig
d %>% 
  mutate(docket_id = str_split(docket_id, ";")) %>% 
  unnest(docket_id) %>% 
    add_count(org_type2, name = "dataset_total") %>% 
  count(org_type2, docket_id, dataset_total, sort = T) %>%
  mutate(percent = percent( n / dataset_total , accuracy = 1)) %>% 
  kablebox()
```


### Percent of each organization type on any one rule

```{r}
# orgs (15% of nonprofits on payday loan rule, 30% of opensecrets)
d %>% 
 mutate(docket_id = str_split(docket_id, ";")) %>% 
  unnest(docket_id) %>% 
  # org rather than comment level counts now
  distinct(org_name, docket_id, org_type2) %>% 
  # total orgs of each type  in the dataset 
  add_count(org_type2, name = "dataset_total") %>% 
  # number of each org type by docket 
  count(org_type2, docket_id, `dataset_total`, sort = T) %>%
  mutate(percent = percent( n / dataset_total , accuracy = 1)) %>% 
  kablebox()
```

### Most Frequently Commenting Orgs
```{r}
# 
d %>% 
  # filter(comment_agency == "CFPB") %>% 
  # mutate(docket_id = comment_url %>% str_extract("CFPB-[0-9]*-[0-9]*")) %>% 
  count(best_match_name, org_type2, docket_id, sort = T) %>% kablebox()
```


# Probability of Commenting

These models have the prefix `mp_`. The dependent variable is the probability that the organization comments.

### Banks

SM = Comptroller of the Currency (OCC). National Charter and a Fed member.

NM = Commercial Bank. The bank is supervised by the Federal Deposit Insurance Corporation (FDIC). State charter and Fed non-member

SB = Savings Bank. The bank is supervised by the Federal Deposit Insurance Corporation (FDIC). State Charter.

OI = Bank is an insured United States branch of a foreign chartered institution (IBA)

N = National Associations (Ommitted)

Assets in hundreds of millions

```{r cache=FALSE}
# FDIC_resources %>% filter(BKCLASS == "NM")


FDIC_resources %<>% mutate(Class = str_c(" ", BKCLASS) %>% as.factor() ,
                           ASSETS_m = ASSET/1000000,
                           ASSETS = ASSET/100000000,
                           Assets = ASSET/1000000000) 

# make savings associations the ref category 
FDIC_resources$Class %<>% relevel(ref = " SA")
# %>% 
#   mutate(BKCLASS = BKCLASS %>% str_replace("^NM", "SBNM"))  %>% 
#   mutate(BKCLASS = BKCLASS %>% str_replace("^NM", "SBNM"))

unique(FDIC_resources$BKCLASS)
unique(FDIC_resources$Class)


```


```{r mp-FDIC, cache=FALSE, fig.height=2, fig.width=6}
#mpFDIC
mpFDICbillions <- glm(commented ~ Assets,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDIC <- glm(commented ~ ASSETS_m,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDIC_BKCLASSonly <- glm(commented ~ Class,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDIC_BKCLASS <- glm(commented ~ ASSETS_m + Class,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDICxBKCLASS <- glm(commented ~ ASSETS_m*Class,
           data = FDIC_resources, 
             family=binomial(link="logit"))


rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Comment",
  `2` = "Comment",  
  #`3` = "Comment"
)

attr(rows, 'position') <- c(0)

models <- list(mpFDIC,# mpFDIC_BKCLASSonly,
               mpFDIC_BKCLASS#,
               #mpFDICxBKCLASS
               )

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

modelplot(models[1:2]) +
  labs(title  = "Banks",
x = "Change in Log Odds of Commenting",
caption = "Reference Category = Savings Associations") +
  theme(panel.grid.major.x =  element_blank(),
        panel.grid.major.y =  element_blank()) + 
  scale_color_viridis_d(end = .6)


save(models, rows, 
     file = here::here("models", "mpFDIC.Rdata"))
```


#### Predicted probabibility of commenting by bank type

```{r mp-FDIC-predict, fig.height=2.5, fig.width=4.5}
 
 # A data frame of values at which to estimate probabilities:
values <- FDIC_resources %>% 
  #filter(org_type == "Bank") %>% 
  tidyr::expand(ASSETS_m = seq(0,10,1),
                Class)#, org_type = "Bank") 

predicted <- marginaleffects::predictions(mpFDICxBKCLASS,
                         newdata = values) 

names(predicted)


# As a plot
p <- predicted %>% 
  mutate(Class = Class %>% 
           str_replace("NM", "Commercial bank") %>% 
      str_replace("SB", "Savings bank") %>% 
      str_replace("OI", "Foreign chartered institution") %>% 
      str_replace("N$", "National association") %>% 
        str_replace("SA", "Savings association") %>% 
        str_replace("SM", "State commercial bank")
    ) %>% 
  ggplot() + 
  aes(x = ASSETS_m, y = estimate, shape = Class, color = Class
      ) + 
  geom_pointrange(aes(ymin = conf.low,
                  ymax = conf.high), 
                  alpha = .7,
                  position = position_dodge(width = .5) 
                  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  #coord_flip() +
  labs(y = 'Probability of Commenting', 
       x = "Assets (Millions)",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        #panel.grid.major.y = element_blank()
        )+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma")  

p 
```


```{r mp-FDIC2, cache=FALSE, fig.height=2, fig.width=6}
FDIC_resources %<>% mutate(Class2 = ifelse(
  str_detect(Class, "NM|SM"),
  "Commercial bank",
  "Non-commercial bank"
))


#mpFDIC
mpFDICbillions <- glm(commented ~ Assets,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDIC <- glm(commented ~ ASSETS_m,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDIC_BKCLASSonly <- glm(commented ~ Class2,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDIC_BKCLASS <- glm(commented ~ ASSETS_m + Class2,
           data = FDIC_resources, 
             family=binomial(link="logit"))

mpFDICxBKCLASS <- glm(commented ~ ASSETS_m*Class2,
           data = FDIC_resources, 
             family=binomial(link="logit"))


rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Comment",
  `2` = "Comment",  
  `3` = "Comment"
)

attr(rows, 'position') <- c(0)

models <- list(mpFDIC,# mpFDIC_BKCLASSonly,
               mpFDIC_BKCLASS,
               mpFDICxBKCLASS
               )

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

modelplot(models[1:2]) +
  labs(title  = "Banks",
x = "Change in Log Odds of Commenting",
caption = "Reference Category = Commercial Bank") +
  theme(panel.grid.major.x =  element_blank(),
        panel.grid.major.y =  element_blank()) + 
  scale_color_viridis_d(end = .6)


save(models, rows,
     file = here::here("models", "mpFDIC2.Rdata"))
```


#### Predicted probabibility of commenting by bank type

```{r mp-FDIC2-predict, fig.height=2.5, fig.width=4.5}
 
 # A data frame of values at which to estimate probabilities:
values <- FDIC_resources %>% 
  #filter(org_type == "Bank") %>% 
  tidyr::expand(ASSETS_m = seq(0,200,50),
                Class2)#, org_type = "Bank") 

predicted <- marginaleffects::predictions(mpFDICxBKCLASS,
                         newdata = values) 

names(predicted)


# As a plot
p <- predicted %>% 
  mutate(Class2 = str_replace(Class2, " ", "\n")) %>% 
  ggplot() + 
  aes(x = ASSETS_m, y = estimate, shape = Class2, color = Class2
      ) + 
  geom_pointrange(aes(ymin = conf.low,
                  ymax = conf.high), 
                  alpha = .7,
                  position = position_dodge(width = .5) 
                  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  #coord_flip() +
  labs(y = 'Probability of Commenting', 
       x = "Assets (Millions)",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        #panel.grid.major.y = element_blank()
        )+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma")  

p 
```

### Non-profits

Assets in billions

```{r mp-nonprofits}
nonprofit_resources %<>% mutate(Assets = assets/1000000000)

mpNonprofit <- glm(commented ~ Assets,
           data = nonprofit_resources , 
             family=binomial(link="logit"))

mpNonprofit_revenue <- glm(commented ~ Assets + revenue,
           data = nonprofit_resources, 
             family=binomial(link="logit"))

models <- list(mpNonprofit, mpNonprofit_revenue)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Comment",
  `2` = "Comment",  
)

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

modelplot(models)+ 
  theme(panel.grid.major.x =  element_blank()) + 
  labs(x = "Change in Log Odds of Commenting")
```

### Credit Unions

Assets in billions

 
```{r mp-credit-unions}
creditunions %<>% mutate(Assets = assets/1000000000)


mp_creditunions <- glm(commented ~ Assets,
           data = creditunions, 
             family=binomial(link="logit"))

models <- list(mp_creditunions)


rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Commented",
)

attr(rows, 'position') <- c(0)

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

modelplot(models)+ 
  theme(panel.grid.major.x =  element_blank()) + 
  labs(x = "Change in Log Odds of Commenting per Billion in Assets")
```

### Banks, Non-profits, Credit Unions Compared

```{r mp-nonprofit-credit-unions}
# nonprofit-credit-unions
models <- list(mpFDICbillions, mpNonprofit, mp_creditunions)

names(models) <- c("Banks", "Non-profits", "Credit Unions")


modelplot(models) + 
  theme(panel.grid.major.x =  element_blank()) + 
  labs(x = "Change in Log Odds of Commenting per Billion in Assets") +
  facet_wrap("model", scales = "free", ncol = 1) +
  scale_color_viridis_d(option = "plasma", end = .7)


rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Commented",
  `2` = "Commented",
  `3` = "Commented"
)

attr(rows, 'position') <- c(0)

modelsummary(models)

save(models, rows, 
     file = here::here("models", "pr-of-comment.Rdata"))
```

### Campaign Donors

```{r mp-opensecrets-predict, fig.height=2.5, fig.width=3}
# TODO JOIN org_type2 and lobbying expend

opensecrets %<>% mutate(MeanContribAmount_t = MeanContribAmount/1000,
                        TotalContribAmount_t = TotalContribAmount/1000,
                        MeanContribAmount_m = MeanContribAmount/1000000,
                        TotalContribAmount_m = TotalContribAmount/1000000)

mpOpensecrets <- glm(commented ~ MeanContribAmount_t,
           data = opensecrets, 
             family=binomial(link="logit"))

mpOpensecrets_total <- glm(commented ~ TotalContribAmount_t,
           data = opensecrets, 
             family=binomial(link="logit"))

models <- list(mpOpensecrets, mpOpensecrets_total)

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Commented",
  `2` = "Commented"
)

attr(rows, 'position') <- c(0)


equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)



# A data frame of values at which to estimate probabilities:
values <- opensecrets %>% 
  #filter(org_type == "Bank") %>% 
  tidyr::expand(MeanContribAmount_t = seq(0,500,100) )#, org_type = "Bank") 

predicted <- marginaleffects::predictions(mpOpensecrets,
                         newdata = values) 

names(predicted)


# As a plot
p <- predicted %>% 
  ggplot() + 
  aes(x = MeanContribAmount_t, y = estimate#, shape = org_type, color = org_type
      ) + 
  geom_pointrange(aes(ymin = conf.low,
                  ymax = conf.high), alpha = .7, position = position_dodge(width = 0.010) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  #coord_flip() +
  labs(y = 'Probability of Commenting', 
       x = "PAC Contributions ($1,000s)",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        #panel.grid.major.y = element_blank()
        )+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma")  

p 
```

### By Market Cap
```{r mp-compustat}
compustat %<>% mutate(commented = Commented == "Commented",
                      marketcap_b = marketcap2/1000000000)


mpCompustat <- glm(commented ~ marketcap_b,
           data = compustat, 
             family=binomial(link="logit"))

top_naics <- compustat %>% count(naics, sort = T) %>% 
  drop_na(naics) %>% 
  top_n(10, wt = n) %>% 
  pull(naics)

mpCompustat_naics <- glm(commented ~ NAICS_,
           data = compustat %>% mutate(NAICS_ = ifelse(naics %in% top_naics, naics, "other")), 
             family=binomial(link="logit"))

models <- list(mpCompustat, mpCompustat_naics)

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

#modelplot(models)

 modelplot(mpCompustat)
 
 # modelplot(mpCompustat_naics)

```

#### Predicted probabilites by market cap

```{r mp-compustat-predict, fig.height=2.5, fig.width=3}
 
 # A data frame of values at which to estimate probabilities:
values <- compustat %>% 
  #filter(org_type == "Bank") %>% 
  tidyr::expand(marketcap_b = seq(0,500,100) )#, org_type = "Bank") 

predicted <- marginaleffects::predictions(mpCompustat,
                         newdata = values) 

names(predicted)


# As a plot
p <- predicted %>% 
  ggplot() + 
  aes(x = marketcap_b, y = estimate#, shape = org_type, color = org_type
      ) + 
  geom_pointrange(aes(ymin = conf.low,
                  ymax = conf.high), 
                  alpha = .7,
                  position = position_dodge(width = 0.010) 
                  )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  #coord_flip() +
  labs(y = 'Probability of Commenting', 
       x = "Market Capitalization (Billions)",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        #panel.grid.major.y = element_blank()
        )+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma")  

p 
```

## Together

```{r mp-all}
all <- full_join(
  FDIC_resources %>% dplyr::select(assets = ASSET, commented, org_type = Class) %>% mutate(org_type = "Bank"),
  nonprofit_resources %>% dplyr::select(assets, commented) %>% mutate(org_type = "Non-profit")
) %>% 
  full_join(
  creditunions %>% dplyr::select(assets, commented) %>% mutate(org_type = "Credit union")
  )

all %<>% mutate(assets_b = assets  / 100000000,
                assets_b2 = assets_b^2) # %>% filter(org_type != " SB", org_type != " SM")

mpAll <- glm(commented ~ assets_b + org_type,
           data = all, 
             family=binomial(link="logit"))

mpAlli <- glm(commented ~ assets_b * org_type,
           data = all, 
             family=binomial(link="logit"))

mpAlllog <- glm(commented ~ log(assets_b+1) + org_type,
           data = all, 
             family=binomial(link="logit"))

mpAllilog <- glm(commented ~ log(assets_b+1) * org_type,
           data = all, 
             family=binomial(link="logit"))

mpAllquad <- glm(commented ~ assets_b + assets_b2 + org_type,
           data = all, 
             family=binomial(link="logit"))

mpAlliquad <- glm(commented ~ assets_b * org_type + assets_b2 * org_type ,
           data = all, 
             family=binomial(link="logit"))


models <- list(mpAll, mpAlli,
               mpAlllog, mpAllilog,
               mpAllquad, mpAlliquad
               )

rows <- tibble(
  term = c("Dependent Variable"),
  `1` = "Commented",
  `2` = "Commented",
    `3` = "Commented",
  `4` = "Commented",
  `5` = "Commented",
  `6` = "Commented"
)

attr(rows, 'position') <- c(0)

equatiomatic::extract_eq(models[[1]]) 

modelsummary(models)

# modelplot(models)

save(models, rows,
     file = here::here("models", "mpAll.Rdata"))
```


###  Predicted probability of commenting by assets 

```{r}

range(all$ASSET)


# A data frame of values at which to estimate probabilities:
values <- all %>% 
  #filter(org_type == "Bank") %>% 
  tidyr::expand(assets_b = seq(0,5,1), org_type) %>% 
  mutate(assets_b2 = assets_b^2)
```

### Base model with interactions (2) 
```{r,  mp-all-predict, fig.height=2.5, fig.width=3.5}
predicted <- marginaleffects::predictions(mpAlli,
                         newdata = values) 

names(predicted)


# As a plot
p <- predicted %>% 
  ggplot() + 
  aes(x = assets_b*1000, y = estimate#, shape = org_type, color = org_type
      ) + 
  geom_pointrange(aes(ymin = conf.low,
                  ymax = conf.high), alpha = .7, position = position_dodge(width = 0.010) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  #coord_flip() +
  labs(y = 'Probability of Commenting', 
       x = "Assets (Millions)",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        #panel.grid.major.y = element_blank()
        )+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma")  

p  +  aes(color = org_type) + labs(color = "")


# p +   facet_wrap("org_type", ncol = 1) #+ ylim(0,.5) 


p +  facet_wrap("org_type", ncol = 1, scales = "free") +  aes(color = org_type) + labs(color = "") # + ylim(0,.5) 
```


### Log model with interactions (2) 
```{r,  mp-all-predict-log, fig.height=2.5, fig.width=3.5}
predicted <- marginaleffects::predictions(mpAllilog,
                         newdata = values) 

names(predicted)


# As a plot
p <- predicted %>% 
  ggplot() + 
  aes(x = assets_b, y = estimate#, shape = org_type, color = org_type
      ) + 
  geom_pointrange(aes(ymin = conf.low,
                  ymax = conf.high), alpha = .7, position = position_dodge(width = 0.010) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  #coord_flip() +
  labs(y = 'Probability of Commenting', 
       x = "Assets (Billions)",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        #panel.grid.major.y = element_blank()
        )+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma")  

p + aes(color = org_type) + labs(color = "") # + ylim(0,.5) 


# p +   facet_wrap("org_type", ncol = 1) # + ylim(0,.5) 


#p +  facet_wrap("org_type", ncol = 1, scales = "free")  + aes(color = org_type) + labs(color = "") 
```

### Quadratic model with interactions (6) 

```{r,  mp-all-predict-quad, fig.height=2.5, fig.width=3.5}
predicted <- marginaleffects::predictions(mpAlliquad,
                         newdata = values) 

names(predicted)


# As a plot
p <- predicted %>% 
  ggplot() + 
  aes(x = assets_b, y = estimate#, shape = org_type, color = org_type
      ) + 
  geom_pointrange(aes(ymin = conf.low,
                  ymax = conf.high), alpha = .7, position = position_dodge(width = 0.010) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  #coord_flip() +
  labs(y = 'Probability of Commenting', 
       x = "Assets (Billions)",
       color = "",#color = '"Environmental Justice"\nRaised by Comments',
       shape = "",#shape = '"Environmental Justice"\nRaised by Comments', 
       title = "") + 
  theme_minimal() + 
  theme(#axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        #panel.grid.major.y = element_blank()
        )+
    scale_color_viridis_d(begin = 0, end = .6, option = "plasma")  

p+ aes(color = org_type) + labs(color = "") 

# p +   facet_wrap("org_type", ncol = 1) # + ylim(0,.5) 


#p +  facet_wrap("org_type", ncol = 1, scales = "free")  +  aes(color = org_type)  + labs(color = "")# + ylim(0,.5)

```

```{r mp-all-predict-blank, fig.height=2.5, fig.width=3}
p$layers[1] <- NULL +   facet_wrap("org_type", ncol = 1) 


p  + ylim(0,1) 

#p +   facet_wrap("org_type", ncol = 1)  + ylim(0,1)  +  aes(color = org_type) + labs(color = "") + ylim(0,1) 


```

# TODO 

Priorities for matching that will give us the most leverage:

- [ ] Best match in *each* dataset rather than best match in *one* dataset: https://finreggroup.slack.com/archives/C027MRLQFLJ/p1650733175102459

- [ ] Comments on dockets with 0 comments matched: https://judgelord.github.io/finreg/participation#Asset_data

- [ ] Underpowered subsets, especially marketcap (hopefully matching both compustat and CIK will help with this): https://judgelord.github.io/finreg/participation#By_Market_Cap

- [ ] FDIC `BKCLASS` == "national associations" that we are currently dropping: https://judgelord.github.io/finreg/participation#FDIC_instituttions  https://finreggroup.slack.com/archives/C027MRLQFLJ/p1653322086231879

- [ ] False positives that I am currently dropping https://finreggroup.slack.com/archives/C027MRLQFLJ/p1650658969445029

Analyses to clean up and add to the paper 

- [ ] Lobbying expenditures from CRP (replication of all PAC figures and models)

- [ ] Non-profit revenue (maybe just add the revenue figures and models to the appendix)

- [ ] the full (best-ish) model includes nonprofits, credit unions, and each type of bank as separate org_types. This model is run above but needs to be investigated 

Presentation 

- [ ] Predicted probability plots for all models presented in the paper. These should replace all tables. All tables should appear in the appendix. 

- [ ] Non-profit and credit union plots for the correlation between assets and sophistication

